{% set urltype = "home" %}

{% extends "OlegFellAppBundle::Default/base.html.twig" %}

{% import "OlegUserdirectoryBundle::Default/usermacros.html.twig" as usermacros %}
{% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}
{% import "OlegFellAppBundle::Default/fellappmacros.html.twig" as fellappmacros %}


{% block title %}
    Fellowship Applications
{% endblock %}


{% block content %}

<p>

    {% if is_granted('ROLE_FELLAPP_COORDINATOR') %}
        {% if accessreqs and accessreqs > 0 %}
            <div class="alert alert-warning">
                There are <a href="{{ path(fellapp_sitename~'_accessrequest_list') }}">{{ accessreqs }} unprocessed access request(s)</a>
            </div>
        {% endif %}
    {% endif %}



    <p>

        {#<a href="{{ path('fellapp_home',{'filter[active]':1,'filter[filter]':filter}) }}">#}
            {#Active:{{ activeTotal }}#}
        {#</a>#}
        {#<a href="{{ path('fellapp_home',{'filter[active]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">#}
            {#({{ active }} for {{ currentYear }})#}
        {#</a>#}

        {#<a href="{{ path('fellapp_home',{'filter[complete]':1, 'filter[filter]':filter}) }}">#}
            {#Complete:{{ completeTotal }}#}
        {#</a>#}
        {#<a href="{{ path('fellapp_home',{'filter[complete]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">#}
           {#({{ complete }} for {{ currentYear }})#}
        {#</a>#}

        {#<a href="{{ path('fellapp_home',{'filter[interviewee]':1,'filter[filter]':filter}) }}">#}
            {#Interviewee:{{ intervieweeTotal }}#}
        {#</a>#}
        {#<a href="{{ path('fellapp_home',{'filter[interviewee]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">#}
            {#({{ interviewee }} for {{ currentYear }})#}
        {#</a>#}


        {#<a href="{{ path('fellapp_home',{'filter[onhold]':1,'filter[filter]':filter}) }}">#}
            {#On Hold:{{ onholdTotal }}#}
        {#</a>#}
        {#<a href="{{ path('fellapp_home',{'filter[onhold]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">#}
            {#({{ onhold }} for {{ currentYear }})#}
        {#</a>#}

        {#<a href="{{ path('fellapp_home',{'filter[reject]':1,'filter[filter]':filter}) }}">#}
            {#Rejected:{{ rejectTotal }}#}
        {#</a>#}
        {#<a href="{{ path('fellapp_home',{'filter[reject]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">#}
            {#({{ reject }} for {{ currentYear }})#}
        {#</a>#}


        {#<a href="{{ path('fellapp_home',{'filter[hidden]':1,'filter[filter]':filter}) }}">#}
            {#Hidden:{{ hiddenTotal }}#}
        {#</a>#}
        {#<a href="{{ path('fellapp_home',{'filter[hidden]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">#}
            {#({{ hidden }} for {{ currentYear }})#}
        {#</a>#}

        {#<a href="{{ path('fellapp_home',{'filter[archived]':1,'filter[filter]':filter}) }}">#}
            {#Archived:{{ archivedTotal }}#}
        {#</a>#}
        {#<a href="{{ path('fellapp_home',{'filter[archived]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">#}
            {#({{ archived }} for {{ currentYear }})#}
        {#</a>#}

        <i>Last succesful import: {{ lastImportTimestamp|date('m/d/Y h:i A') }} {{ serverTimeZone }}</i>
    </p>

    {#{% if searchFlag %}#}
        {#{% set resStr = "Applications matching search criteria" %}#}
    {#{% else %}#}
        {#{% set resStr = "Total" %}#}
    {#{% endif %}#}

    {% set fellappTypeId = -1 %}
    {% if filter %}
        {% set fellappTypeId = filter %}
    {% endif %}
    
    {% set resStr = "Applications matching search criteria" %}

    {% if lastImportTimestamp %}
        <p>
            <b>{{ resStr }}: {{ entities.getTotalItemCount }}</b>
            <a href="{{ path('fellapp_download_applicants_list_excel', { 'fellappIds': fellappids, 'currentYear': currentYear, 'fellappTypeId': fellappTypeId }, true) }}" 
                   data-toggle="tooltip" title="Download Fellowship Candidate Data in Excel Format">
                   <span class="glyphicon glyphicon-download" aria-hidden="true"></span>
            </a>  
        </p>
    {% endif %}

    {#<p>#}
        {#<a href="{{ path('fellapp_import') }}">Import from Google</a>#}
    {#</p>#}

    {#<p>#}
        {#<a href="{{ path('fellapp_populate') }}">Populate the Spreadsheet</a>#}
    {#</p>#}

    <p>
        <form action="{{ path('fellapp_home') }}" method="get" {{ form_enctype(fellappfilter) }} class="well form-search">

            <div class="row">                
                <div class="col-xs-2">
                    {#{{ formmacros.fieldDateLabel_vertical(fellappfilter.startDate,'allow-future-date') }}#}
                    {#<div class="input-group input-group-reg date allow-future-date">#}
                        {#{{ form_row(fellappfilter.startDate, {'attr': {'placeholder': 'Start Year'}}) }}#}
                        {#<span class="input-group-addon calendar-icon-button"><i class="glyphicon glyphicon-calendar"></i></span>#}
                    {#</div>#}

                    {{ form_row(fellappfilter.startDate, {'attr': {'placeholder': 'Start Year'}}) }}

                </div>
                {#<div class="col-xs-2">#}
                    {#{{ formmacros.fieldDateLabel_vertical(fellappfilter.endDate,'allow-future-date') }}#}
                {#</div>#}
                <div class="col-xs-4">
                    {{ form_row(fellappfilter.filter,{'attr': {'placeholder': 'Fellowship Type'}}) }}
                </div>
                <div class="col-xs-4">
                    {{ form_row(fellappfilter.search, {'attr': {'placeholder': 'Search by Name'}}) }}
                </div>
                <div class="col-xs-2">
                    <div class="btn-group btn-group-justified">
                        <div class="btn-group">
                            <button type="submit" class="btn btn-sm btn-default fellapp-filter-btn"><i class="icon-search"></i>Filter</button>
                        </div>
                    </div>
                </div>
            </div>

            <br>
            <div class="row text-center">
                <div class="col-xs-12">

                    <div style="white-space: nowrap; display: inline;">
                    {{ form_widget(fellappfilter.active) }}   {{ form_label(fellappfilter.active) }}
                    {#{{ fellappmacros.addBadge( filter, currentYear, active, activeTotal, 'active' ) }}#}
                    <span class="badge" data-toggle="tooltip" title="for {{ currentYear }}">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[active]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">
                    {{ active }}
                    </a>
                    </span>
                    {{ fellappmacros.addSlush() }}
                    <span class="badge" data-toggle="tooltip" title="Total">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[active]':1,'filter[filter]':filter}) }}">{{ activeTotal }}</a>
                    </span>
                    {{ fellappmacros.addLegend('active') }}
                    </div>
                    &nbsp;&nbsp;

                    <div style="white-space: nowrap; display: inline;">
                    {{ form_widget(fellappfilter.complete) }}   {{ form_label(fellappfilter.complete) }}
                    {#{{ fellappmacros.addBadge( filter, currentYear, complete, completeTotal, 'complete' ) }}#}
                    <span class="badge" data-toggle="tooltip" title="for {{ currentYear }}">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[complete]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">
                    {{ complete }}
                    </a>
                    </span>
                    {{ fellappmacros.addSlush() }}
                    <span class="badge" data-toggle="tooltip" title="Total">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[complete]':1,'filter[filter]':filter}) }}">{{ completeTotal }}</a>
                    </span>
                    {{ fellappmacros.addLegend('complete') }}
                    </div>
                    &nbsp;&nbsp;

                    <div style="white-space: nowrap; display: inline;">
                    {{ form_widget(fellappfilter.interviewee) }}   {{ form_label(fellappfilter.interviewee) }}
                    {#{{ fellappmacros.addBadge( filter, currentYear, interviewee, intervieweeTotal, 'interviewee' ) }}#}
                    <span class="badge" data-toggle="tooltip" title="for {{ currentYear }}">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[interviewee]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">
                        {{ interviewee }}
                    </a>
                    </span>
                    {{ fellappmacros.addSlush() }}
                    <span class="badge" data-toggle="tooltip" title="Total">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[interviewee]':1,'filter[filter]':filter}) }}">{{ intervieweeTotal }}</a>
                    </span>
                    {{ fellappmacros.addLegend('interviewee') }}
                    </div>
                    &nbsp;&nbsp;

                    <div style="white-space: nowrap; display: inline;">
                    {{ form_widget(fellappfilter.onhold) }}   {{ form_label(fellappfilter.onhold) }}
                    {#{{ fellappmacros.addBadge( filter, currentYear, onhold, onholdTotal, 'onhold' ) }}#}
                    <span class="badge" data-toggle="tooltip" title="for {{ currentYear }}">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[onhold]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">
                        {{ onhold }}
                    </a>
                    </span>
                    {{ fellappmacros.addSlush() }}
                    <span class="badge" data-toggle="tooltip" title="Total">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[onhold]':1,'filter[filter]':filter}) }}">{{ onholdTotal }}</a>
                    </span>
                    {{ fellappmacros.addLegend('onhold') }}
                    </div>
                    &nbsp;&nbsp;

                    <div style="white-space: nowrap; display: inline;">
                    {{ form_widget(fellappfilter.reject) }}   {{ form_label(fellappfilter.reject) }}
                    {#{{ fellappmacros.addBadge( filter, currentYear, reject, rejectTotal, 'reject' ) }}#}
                    <span class="badge" data-toggle="tooltip" title="for {{ currentYear }}">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[reject]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">
                        {{ reject }}
                    </a>
                    </span>
                    {{ fellappmacros.addSlush() }}
                    <span class="badge" data-toggle="tooltip" title="Total">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[reject]':1,'filter[filter]':filter}) }}">{{ rejectTotal }}</a>
                    </span>
                    {{ fellappmacros.addLegend('reject') }}
                    </div>
                    &nbsp;&nbsp;

                    <div style="white-space: nowrap; display: inline;">
                    {{ form_widget(fellappfilter.hidden) }}   {{ form_label(fellappfilter.hidden) }}
                    {#{{ fellappmacros.addBadge( filter, currentYear, hidden, hiddenTotal, 'hidden' ) }}#}
                    <span class="badge" data-toggle="tooltip" title="for {{ currentYear }}">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[hidden]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">
                        {{ hidden }}
                    </a>
                    </span>
                    {{ fellappmacros.addSlush() }}
                    <span class="badge" data-toggle="tooltip" title="Total">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[hidden]':1,'filter[filter]':filter}) }}">{{ hiddenTotal }}</a>
                    </span>
                    {{ fellappmacros.addLegend('hidden') }}
                    </div>
                    &nbsp;&nbsp;

                    <div style="white-space: nowrap; display: inline;">
                    {{ form_widget(fellappfilter.archived) }}   {{ form_label(fellappfilter.archived) }}
                    {#{{ fellappmacros.addBadge( filter, currentYear, archived, archivedTotal, 'archived' ) }}#}
                    <span class="badge" data-toggle="tooltip" title="for {{ currentYear }}">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[archived]':1,'filter[filter]':filter,'filter[startDate]':currentYear}) }}">
                        {{ archived }}
                    </a>
                    </span>
                    {{ fellappmacros.addSlush() }}
                    <span class="badge" data-toggle="tooltip" title="Total">
                    <a style="color: white;" href="{{ path('fellapp_home',{'filter[archived]':1,'filter[filter]':filter}) }}">{{ archivedTotal }}</a>
                    </span>
                    {{ fellappmacros.addLegend('archived') }}
                    </div>

                </div>
            </div>

            {{ form_rest(fellappfilter) }}
        </form>
    </p>

    {% set trclassname = "" %}

    <div style="margin-top:25px;">

        <table class="records_list table table-hover table-condensed text-left">
            <thead>
            <tr>

                {#<th {% if entities.isSorted('fellapp.id') %} class="sorted"{% endif %}>{{ knp_pagination_sortable(entities, 'ID', 'fellapp.id') }}</th>#}
                {#<th>{{ knp_pagination_sortable(entities, 'Status', 'fellapp.appStatus.name') }}</th>#}
                {#<th>{{ knp_pagination_sortable(entities, 'Created', 'fellapp.timestamp') }}</th>#}

                <th>{{ knp_pagination_sortable(entities, 'Fellowship Type', 'fellowshipSubspecialty.name') }}</th>
                <th>{{ knp_pagination_sortable(entities, 'Start Date', 'fellapp.startDate') }}</th>
                <th>{{ knp_pagination_sortable(entities, 'ID', 'fellapp.id') }}</th>
                <th>Photo</th>
                <th>{{ knp_pagination_sortable(entities, 'Last Name', 'applicantinfos.lastName') }}</th>
                <th>{{ knp_pagination_sortable(entities, 'First Name', 'applicantinfos.firstName') }}</th>

                <th>{{ knp_pagination_sortable(entities, 'U1', 'examinations.USMLEStep1Score') }}</th>
                <th>{{ knp_pagination_sortable(entities, 'U2', 'examinations.USMLEStep2CKScore')}}</th>
                <th>{{ knp_pagination_sortable(entities, 'U3', 'examinations.USMLEStep3Score') }}</th>

                <th>{{ knp_pagination_sortable(entities, 'C1', 'examinations.COMLEXLevel1Score') }}</th>
                <th>{{ knp_pagination_sortable(entities, 'C2', 'examinations.COMLEXLevel2Score') }}</th>
                <th>{{ knp_pagination_sortable(entities, 'C3', 'examinations.COMLEXLevel3Score') }}</th>

                <th>{{ knp_pagination_sortable(entities, 'Interview Date', 'fellapp.interviewDate') }}</th>
                <th>{{ knp_pagination_sortable(entities, 'Interview Score', 'fellapp.interviewScore') }}</th>

                <th>
                    <div data-toggle="tooltip" title="View Complete Application PDF">
                        <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>
                    </div>
                </th>

                {#{% if is_granted('ROLE_FELLAPP_COORDINATOR') %}#}
                <th>
                    Actions
                </th>
                {#{% endif %}#}

            </tr>
            </thead>
            <tbody data-link="row" class="rowlink">

            {% for entity in entities %}

                {#Set row color#}
                {% set trclassname = "" %}

                {% if entity.appStatus.name == 'archive' %}
                    {#No attention required - plain complete order#}
                    {#{% set trclassname = "action-cancel-status" %}#}
                    {% set trclassname = "info" %}
                {% endif %}

                {% if entity.appStatus.name == 'hide' %}
                    {#urgent attention required#}
                    {#{% set trclassname = "order-urgent-status" %}#}
                    {% set trclassname = "danger" %}
                {% endif %}

                {% if entity.appStatus.name == 'complete' %}
                    {#urgent attention required#}
                    {#{% set trclassname = "order-neutral-status" %}#}
                    {% set trclassname = "order-complete-status" %}
                {% endif %}

                {% if entity.appStatus.name == 'interviewee' %}
                    {#urgent attention required#}
                    {% set trclassname = "order-interviewee-status" %}
                    {#{% set trclassname = "success" %}#}
                {% endif %}

                {% if entity.appStatus.name == 'reject' %}
                    {% set trclassname = "order-reject-status" %}
                {% endif %}

                {% if entity.appStatus.name == 'onhold' %}
                    {% set trclassname = "order-onhold-status" %}
                {% endif %}
                {#EOF Set row color#}

                {#Set examination score#}
                {% set u1 = "" %}
                {% set u2 = "" %}
                {% set u3 = "" %}
                {% set c1 = "" %}
                {% set c2 = "" %}
                {% set c3 = "" %}
                {% for examination in entity.examinations %}
                    {% set u1 = examination.USMLEStep1Score %}
                    {% set u2 = examination.USMLEStep2CKScore %}
                    {% set u3 = examination.USMLEStep3Score %}
                    {% set c1 = examination.COMLEXLevel1Score %}
                    {% set c2 = examination.COMLEXLevel2Score %}
                    {% set c3 = examination.COMLEXLevel3Score %}
                {% endfor %}
                {#EOF Set examination score#}

                
                {#Calculating evaluation received, score css and evaluation modal#}
                {% set interviewDescrStr = "" %}
                {% set interviewsArr = [] %}
                {% set interviewsAwaitingArr = [] %}
                {% if entity.interviewScore %}
                    {% set scoreCount = 0 %}
                    {% set tooltip = "" %}                      
                    {% set scoreStyle = 'style=font-weight:bold;' %}
                    {% for interview in entity.interviews %}
                        {% if not interview.totalRank %}
                            {% set scoreStyle = "" %}                             
                            {% set interviewsAwaitingArr = interviewsAwaitingArr|merge([interview.interviewer.getUsernameOptimal()]) %}
                        {% else %}
                            {% set scoreCount = scoreCount + 1 %} 
                            {% set interviewDescrStr = "<strong>"~interview.interviewer.getUsernameOptimal()~"</strong>:<br>"~
                                    "Academic Rank - "~interview.academicRank~
                                    "<br>Personality Rank - "~interview.personalityRank~
                                    "<br>Potential Rank - "~interview.potentialRank~
                                    "<br>Language Proficiency - "~interview.languageProficiency~
                                    "<br>Total Rank - "~interview.totalRank~
                                    "<br>Comment: "~interview.comment %}
                            {% set interviewsArr = interviewsArr|merge([interviewDescrStr]) %}                              
                        {% endif %}                                                                 
                    {% endfor %}                                   

                    {% if entity.interviewScore %}
                        {% set tooltip = scoreCount~' of '~entity.interviews|length~' interview evaluations received.' %}
                    {% endif %}
                {% endif %}
                {#EOF Calculating evaluation received and evaluation modal#}

                <tr class="{{ trclassname }}">

                    <td>
                        {% if entity.fellowshipSubspecialty %}
                            {{  entity.fellowshipSubspecialty.name }}
                        {% endif %}
                    </td>

                    <td>
                        {{ entity.startDate|date('m/d/Y','UTC') }}
                    </td>

                    <td>
                        <a href="{{ path(pathbase~'_show', { 'id': entity.id }) }}" target="_blank">{{ entity.id }}</a>
                    </td>

                    <td class="rowlink-skip">
                        {% if is_granted('ROLE_PLATFORM_DEMO') %}
                            {% set avatarImage = asset('bundles/oleguserdirectory/fengyuanchen-image-cropper/img/Placeholder-User-Glyph-Icon.png') %}
                            <img src="{{ avatarImage }}" alt="Avatar" style="max-width:100%; max-height:100%;">
                        {% else %}
                            {% if entity.avatars|length > 0 %}
                                {#height="60" width="60"#}
                                <div style="height: 60px; width: 60px;">
                                    {#{% if '.pdf' in entity.user.avatar.getAbsoluteUploadFullPath %}#}
                                    {#&#123;&#35;<embed src="{{ entity.user.avatar.getAbsoluteUploadFullPath }}" alt="Avatar" style="max-width:100%; max-height:100%;" type='application/pdf' >&#35;&#125;#}
                                    {#<object data="{{ entity.user.avatar.getAbsoluteUploadFullPath }}" type="application/pdf" style="max-width:100%; max-height:100%;"></object>#}
                                    {#{% else %}#}
                                    {#<img src="{{ entity.user.avatar.getAbsoluteUploadFullPath }}" alt="Avatar" style="max-width:100%; max-height:100%;">#}
                                    {#{% endif %}#}
                                    {{ usermacros.showDocumentAsImage(entity.avatars|last,'Avatar','') }}
                                </div>
                            {% endif %}
                        {% endif %}
                    </td>

                    {#<td>#}
                        {#{{  entity.appStatus }}#}
                    {#</td>#}

                    {#<td>#}
                        {#{{ entity.timestamp|date('m/d/Y H:i') }}#}
                    {#</td>                                       #}

                    {#<td>#}
                        {#{{ entity.endDate|date('m/d/Y') }}#}
                    {#</td>#}

                    <td>
                        {% if is_granted('ROLE_PLATFORM_DEMO') %}
                            Applicant
                        {% else %}
                            {{ entity.user.getLastNameUppercase() }}
                        {% endif %}
                    </td>

                    <td>
                        {% if is_granted('ROLE_PLATFORM_DEMO') %}
                            Demo
                        {% else %}
                            {{ entity.user.getFirstNameUppercase() }}
                        {% endif %}
                    </td>


                    <td>
                        {{ u1 }}
                    </td>

                    <td>
                        {{ u2 }}
                    </td>

                    <td>
                        {{ u3 }}
                    </td>


                    <td>
                        {{ c1 }}
                    </td>

                    <td>
                        {{ c2 }}
                    </td>

                    <td>
                        {{ c3 }}
                    </td>

                    {#Add a black tooltip over the interview date link in the Interview Date column with text "Download Itinerary"#}
                    <td class="rowlink-skip">
                        {% if entity.interviewDate is not empty %}
                            {% if entity.itinerarys|length > 0 %}
                                <a  
                                   href="{{ path('fellapp_file_download', { 'id': entity.itinerarys|last.id}) }}" 
                                   target="_blank" 
                                   style="color:black;"
                                   data-toggle="tooltip" title="Download Itinerary"
                                >
                                    {{ entity.interviewDate|date('m/d/Y','UTC') }}
                                </a>
                            {% else %}
                                {{ entity.interviewDate|date('m/d/Y','UTC') }}
                            {% endif %}

                        {% endif %}
                    </td>
                   
                    <td class="rowlink-skip">
                        <div>
                            <div style="float:left; margin-right:5px;">
                        {% if entity.interviewScore %}                         
                            <a data-toggle="tooltip" title="{{ tooltip }}" href="{{ path('fellapp_show', { 'id': entity.id}) }}#interviews" target="_blank" style="color:black;">
                                <div {{ scoreStyle }}>{{ entity.interviewScore }}</div>
                            </a>                           
                        {% endif %} 
                                </div>
                                <div style="float:left;">
                        {% if interviewsArr|length > 0 or interviewsAwaitingArr|length > 0 %}                                                                                                         
                            <a href="#" data-toggle="modal" data-target="#interview-info-{{entity.id}}">
                                <span class="glyphicon glyphicon-list"></span>
                            </a>
                        
                            {{ fellappmacros.addInterviewsModal(entity,interviewsArr,interviewsAwaitingArr) }}
                        {% endif %}
                            </div>
                        </div>
                    </td>

                    <td class="rowlink-skip">

                        {% set styleStr = "" %}
                        {% set letterCountStr = "" %}
                        {#X of Y reference letters received (removed by now as asked by Jessica)#}
                        {#count all reference letters and upload documents#}
                        {% set notEmptyRef = 0 %}
                        {% set letterCount = 0 %}
                        {% set totalDocCount = 0 %}
                        {% for refLetter in entity.references %}
                            {% set totalDocCount = totalDocCount + refLetter.documents|length %}
                            {% if refLetter.name %}
                                {% set notEmptyRef = notEmptyRef + 1 %}
                                {% if refLetter.documents|length > 0 %}
                                    {% set letterCount = letterCount + 1 %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% set letterCountStr = "" %}
                        {% set styleStr = "color:#707070;" %}

                        {#{% if letterCount > 0 %}#}
                            {#{% set letterCountStr = letterCount ~  " reference letters received" %}#}
                            {#{% set styleStr = "" %}#}
                        {#{% endif %}#}

                        {% if entity.appStatus.name == 'complete' %}
                            {% set letterCountStr = "Complete" %}
                        {% elseif entity.appStatus.name == 'interviewee' %}
                            {% set letterCountStr = "Interviewee" %}
                        {% else %}
                            {#X of Y reference letters received#}
                            {% set docNumberStr = "docs" %}
                            {% if totalDocCount == 1 %}
                                {% set docNumberStr = "doc" %}
                            {% endif %}
                            {% set letterCountStr = letterCount~" of "~notEmptyRef~" reference letters ("~totalDocCount~" "~docNumberStr~") received" %}
                            {% set styleStr = "" %}
                        {% endif %}

                        {#<a#}
                            {#href="{{ path('employees_file_pdf-preview', { 'id': entity.id}) }}" target="_blank">#}
                            {#<span class="glyphicon glyphicon-file" aria-hidden="true"></span>#}
                        {#</a>#}
                        {% if entity.getRecentReport() %}
                            <a href="{{ entity.getRecentReport().getAbsoluteUploadFullPath }}" target="_blank" data-toggle="tooltip" title="{{ letterCountStr }}">
                                <span class="glyphicon glyphicon-file" aria-hidden="true" style="{{ styleStr }}"></span>
                            </a>                            
                        {% endif %}                                                                       

                    </td>

                    <td class="rowlink-skip">

                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                Action <span class="caret"></span>
                            </button>

                            <ul class="dropdown-menu dropdown-menu-right">


                                <li>
                                    <a
                                        href="{{ path('fellapp_show', { 'id': entity.id}) }}" target="_blank">View Application and Documents
                                    </a>
                                </li>

                                {% if entity.itinerarys|length > 0 %}
                                    <li>
                                        <a
                                            href="{{ path('fellapp_file_download', { 'id': entity.itinerarys|last.id}) }}">Download Itinerary
                                        </a>
                                    </li>
                                {% endif %}

                                {% if entity.interviews|length > 0 %}
                                    <li>
{#                                        <a href="{{ path('fellapp_show', { 'id': entity.id}) }}#interviews" target="_blank">View Interview Evaluations</a>#}
                                        {% if interviewsArr|length > 0 or interviewsAwaitingArr|length > 0 %}                                                                                                         
                                            <a href="#" data-toggle="modal" data-target="#interview-info-{{entity.id}}">
                                                View Interview Evaluations <span class="glyphicon glyphicon-list"></span>
                                            </a>                                                  
                                        {% endif %}
                                    </li>
                                {% endif %}

                                {% if is_granted('ROLE_FELLAPP_COORDINATOR') or is_granted('ROLE_FELLAPP_DIRECTOR') %}
                                    {% if entity.appStatus.name != 'active' %}
                                        <li>
                                            <a
                                                    general-data-confirm="Are you sure you want to change status of this Application to 'Active'?"
                                                    general-data-callback="refreshpage"
                                                    href="{{ path('fellapp_status', { 'id': entity.id, 'status': 'active' }, true) }}">Mark as Active
                                            </a>
                                        </li>
                                    {% endif %}

                                    {% if entity.appStatus.name != 'complete' %}
                                        {% set filter = app.request.get('filter') %}
                                        <li>
                                            <a
                                                general-data-confirm="Are you sure you want to mark this Application as 'Complete'?"
                                                general-data-callback="refreshpage"
                                                href="{{ path('fellapp_status', { 'id': entity.id, 'status': 'complete' }, true) }}">Mark as Complete
                                            </a>
                                        </li>
                                    {% endif %}

                                    {% if entity.appStatus.name != 'interviewee' %}
                                        <li>
                                            <a
                                                    general-data-confirm="Are you sure you want to mark this Application as belonging to an Interviewee?"
                                                    general-data-callback="refreshpage"
                                                    href="{{ path('fellapp_status', { 'id': entity.id, 'status': 'interviewee' }, true) }}">Mark as an Interviewee
                                            </a>
                                        </li>
                                    {% endif %}



                                    {% if entity.appStatus.name != 'reject' %}
                                        <li>
                                            <a
                                                    general-data-confirm="Are you sure you want to change status of this Application to 'Rejected'?"
                                                    general-data-callback="refreshpage"
                                                    href="{{ path('fellapp_status', { 'id': entity.id, 'status': 'reject' }, true) }}">Mark as Rejected
                                            </a>
                                        </li>
                                    {% endif %}


                                    {% if entity.appStatus.name != 'onhold' %}
                                        <li>
                                            <a
                                                    general-data-confirm="Are you sure you want to change status of this Application to 'On Hold'?"
                                                    general-data-callback="refreshpage"
                                                    href="{{ path('fellapp_status', { 'id': entity.id, 'status': 'onhold' }, true) }}">Put On Hold
                                            </a>
                                        </li>
                                    {% endif %}


                                    {% if entity.appStatus.name != 'hide' %}
                                        <li>
                                            <a
                                                general-data-confirm="Are you sure you want to hide this Application?"
                                                general-data-callback="refreshpage"
                                                href="{{ path('fellapp_status', { 'id': entity.id, 'status': 'hide' }, true) }}">Hide
                                            </a>
                                        </li>
                                    {% endif %}

                                    {% if entity.appStatus.name != 'archive' %}
                                        <li>
                                            <a
                                                general-data-confirm="Are you sure you want to change status of this Application to 'Archived'?"
                                                general-data-callback="refreshpage"
                                                href="{{ path('fellapp_status', { 'id': entity.id, 'status': 'archive' }, true) }}">Archive
                                            </a>
                                        </li>
                                    {% endif %}

                                    {% if entity.getRecentReport() %}
                                        {#Invite Interviewers to Rate#}
                                        {% if entity.interviews|length > 0 %}
                                            <li>
                                                <a
                                                    general-data-confirm="Are you sure you want to Invite Interviewers to Rate this Applicant? Email will be sent to the interviewers who still have not submitted their scores."
                                                    general-data-callback="refreshpage"
                                                    href="{{ path('fellapp_inviteinterviewerstorate', { 'id': entity.id}, true) }}">Invite Interviewers to Rate
                                                </a>
                                            </li>
                                        {% endif %}

                                        {#Invite observers to view#}
                                        {% if entity.observers|length > 0 %}
                                            <li>
                                                <a
                                                    general-data-confirm="Are you sure you want to Invite Observers to view this Applicant? Email will be sent to all observers."
                                                    general-data-callback="refreshpage"
                                                    href="{{ path('fellapp_inviteobservers', { 'id': entity.id}, true) }}">Invite Observers to View
                                                </a>
                                            </li>
                                        {% endif %}
                                    {% endif %}

                                    <li>
                                        <a
                                            href="{{ path('fellapp_edit', { 'id': entity.id}) }}" target="_blank">Edit
                                        </a>
                                    </li>

                                {% endif %}

                                {#{% if is_granted('ROLE_PLATFORM_ADMIN') %}#}
                                {#<li>#}
                                    {#<a#}
                                        {#general-data-confirm="Are you sure you want to completely remove this Applicant and all related documents?"#}
                                        {#href="{{ path('fellapp_remove', { 'id': entity.id}) }}">Remove Applicant and all related documents#}
                                    {#</a>#}
                                {#</li>#}
                                {#{% endif %}#}
                                    
                                {#This link should only appear if the logged in user is one of the interviewers.#}
                                {% if is_granted('ROLE_FELLAPP_INTERVIEWER') %}
                                    
                                    {% set userInterviewId = entity.getUserInterviewId( app.security.getToken().getUser() ) %}                                  
                                    
                                    {% if userInterviewId %}
                                        <li>
                                            <a
                                                href="{{ path('fellapp_interview_edit', { 'id': userInterviewId}) }}" target="_blank">Submit My Evaluation
                                            </a>
                                        </li>
                                    {% endif %} 
                                    
                                {% endif %}   
                                    

                                <li>
                                    <a
                                        href="{{ path('fellapp_download_pdf', { 'id': entity.id}) }}">Download Application
                                    </a>
                                </li>

                            </ul>

                        </div>

                    </td>


                </tr>
            {% endfor %}

            </tbody>
        </table>

        {# display navigation #}
        <div class="navigation">
            {{ knp_pagination_render(entities) }}
        </div>

{% endblock %}



{% block additionaljs %}

    <script language="Javascript">

        $(document).ready(function() {

            $('[data-toggle="tooltip"]').tooltip({html: true});           

            var target = ".datepicker-only-year";

            var datefilter = $(target).datepicker( {
                autoclose: true,
                format: " yyyy",
                viewMode: "years",
                minViewMode: "years",
                orientation: 'auto top'
            });

            attachTitleToScores();

            /////////// set default year by JS ///////////
            //var year = parseInt(new Date().getFullYear()) + 2;
            //var datas = [
            //    new Date(year,1,1) //remember months in javascript starts with 0 for january
            //];
            //console.log('datepicker val='+datefilter.val());
            //if( !datefilter.val() ) {
            //    datefilter.datepicker('setDate', datas);
            //}

            //var url = window.location.href;
            //console.log('url='+url);
            //var year = getParameterByName('filter%5BstartDate%5D');
            //console.log('year='+year);

        });


//        function getParameterByName(name) {
//            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
//            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
//                    results = regex.exec(location.search);
//            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
//        }


        function refreshpage(href) {
            //console.log('refreshpage href='+href);

            if( !href ) {
                return;
            }

            var url = getCommonBaseUrl(href,"fellowship-applications");
            //console.log('url='+url);

            $.ajax({
                type: "GET",
                url: url,
                success: function(data) {
                    //console.log('result='+data);
                }
            });

            location.reload();
        }


        function attachTitleToScores() {
            $('.sortable').each( function() {
                var title = this.title;
                //console.log("title="+title);
                var tooltipStr = null;
                switch( this.title ) {
                    case 'U1':
                        tooltipStr = 'USMLE Step 1 Score';
                        break;
                    case 'U2':
                        tooltipStr = 'USMLE Step 2 CK Score';
                        break;
                    case 'U3':
                        tooltipStr = 'USMLE Step 3 Score';
                        break;
                    case 'C1':
                        tooltipStr = 'COMLEX 1 Score';
                        break;
                    case 'C2':
                        tooltipStr = 'COMLEX 2 Score';
                        break;
                    case 'C3':
                        tooltipStr = 'COMLEX 3 Score';
                        break;
                }

                if( tooltipStr ) {
                    this.title = tooltipStr;
                    $(this).tooltip();
                }
            });
        }


    </script>

{% endblock %}


