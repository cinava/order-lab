{#
    Copyright 2017 Cornell University

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
#}

{% macro simpleDateField(label,value,placeholder) %}

    <p>
    <div class="row">
        <div class="col-xs-6" align="right">
            <label>{{ label|raw }}</label>
        </div>
        <div class="col-xs-6" align="left" class="form_body_toggle_btn">
            <div class="input-group input-group-reg date allow-future-date">
                <input class="form-control form-control-modif not-mapped-simplefield" type="text" value="{{ value }}" placeholder="{{ placeholder }}">
                <span class="input-group-addon calendar-icon-button"><i class="glyphicon glyphicon-calendar"></i></span>
            </div>
        </div>
    </div>
    </p>

{% endmacro %}

{% macro singleDateField(value,placeholder) %}
    {#<p>#}
        <div class="input-group input-group-reg date allow-future-date">
            <input class="form-control form-control-modif not-mapped-simplefield" type="text" value="{{ value }}" placeholder="{{ placeholder }}">
            <span class="input-group-addon calendar-icon-button"><i class="glyphicon glyphicon-calendar"></i></span>
        </div>
    {#</p>#}
{% endmacro %}


{% macro complexPatient(ID,Active,lastName,firstName,MRN,InOut,HLAA,HLAB,RogosinDate,RogosinPRA,NYBCDate,ProductStatus,Expires) %}
    {% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}
    {% import "OlegCallLogBundle::Default/calllogmacros.html.twig" as calllogmacros %}

    <tr class="">
        <td> <a href="#">{{ ID }}</a> </td>
        <td>{{ Active }}</td>
        <td>{{ lastName }}</td>
        <td>{{ firstName }}</td>
        <td>{{ MRN }}</td>
        <td>{{ InOut }}</td>
        <td>{{ HLAA }}</td>
        <td>{{ HLAB }}</td>
        <td>{{ RogosinDate }}</td>
        <td>{{ RogosinPRA }}</td>
        <td>{{ NYBCDate }}</td>
        <td>{{ ProductStatus }}</td>
        <td>{{ Expires }}</td>

        <td class="rowlink-skip">

            <!-- Modal -->
            <div class="modal fade" id="edit_{{ ID }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close comment_modal_close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title text-center" id="myModalLabel">Edit Complex Patient ID {{ ID }}</h4>
                        </div>
                        <div class="modal-body">

                            <div id="modal_error_4" class="modal_error_div"></div>

                            <form id="addcomment_form">

                                {{ formmacros.simplefield('Active:',Active,'input') }}
                                {{ formmacros.simplefield('Last Name:',lastName,'input') }}
                                {{ formmacros.simplefield('First Name:',firstName,'input') }}
                                {{ formmacros.simplefield('In/Out:',InOut,'input') }}
                                {{ formmacros.simplefield('HLAA:',HLAA,'input') }}
                                {{ formmacros.simplefield('HLAB:',HLAB,'input') }}
                                {{ calllogmacros.simpleDateField('Rogosin Date:',RogosinDate,'Rogosin Date') }}
                                {{ formmacros.simplefield('RogosinPRA:',RogosinPRA,'input') }}
                                {{ calllogmacros.simpleDateField('NYBC Date:',NYBCDate,'NYBC Date') }}
                                {{ formmacros.simplefield('Product Status:',ProductStatus,'input') }}
                                {{ calllogmacros.simpleDateField('Expires:',Expires,'Expires') }}

                                <div class="center-block">
                                    <input id="edit_{{ ID }}" class="btn btn-primary center-block" type="button" value="Edit"/>
                                </div>

                            </form>

                        </div>
                    </div>
                </div>
            </div>


            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    Action <span class="caret"></span>
                </button>


                <ul class="dropdown-menu dropdown-menu-right">

                    <li>
                        <a href="#" data-toggle="modal" data-target="#edit_{{ ID }}">Edit</a>
                    </li>

                </ul>

            </div>


        </td>
    </tr>
{% endmacro %}


{% macro patientInfoSectionView(form,encounterPatientInfo,cycle,holderId,title,formtype) %}

    {% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}

    <div id="{{holderId}}" class="calllog-patient-holder">

        {#form.vars.value.id={{ form.vars.value.id }}#}
        <input type="hidden" id="calllog-patient-id-{{holderId}}" class="calllog-patient-id" value="{{ form.vars.value.id }}" />

        <div class="panel panel-primary">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a class="calllog-patient-panel-title" data-toggle="collapse" href="#calllog-PatientInformation-{{holderId}}">
                        {#{{ title }}#}
                        {{ form.vars.value.obtainPatientInfoSimple|raw }}
                    </a>
                </h4>
            </div>
            <div id="calllog-PatientInformation-{{holderId}}" class="calllog-patient-information-panel panel-collapse collapse">
                <div class="panel-body">

                    <br>

                    <div id="calllog-danger-box" class="alert alert-danger" style="display: none; margin-top: 5px;"></div>

                    <div id="calllog-matching-patients" style="display: none; margin-top: 5px;"></div>

                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-info -->

    </div>

{% endmacro %}

{% macro patientInfoSection(form,cycle,holderId,title,formtype) %}

    {% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}

    <div id="{{holderId}}" class="calllog-patient-holder">

    {#form.vars.value.id={{ form.vars.value.id }}#}
    <input type="hidden" id="calllog-patient-id-{{holderId}}" class="calllog-patient-id" value="{{ form.vars.value.id }}" />

    <div class="panel panel-primary">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a class="calllog-patient-panel-title" data-toggle="collapse" href="#calllog-PatientInformation-{{holderId}}">
                    {{ title }}
                </a>
            </h4>
        </div>
        <div id="calllog-PatientInformation-{{holderId}}" class="calllog-patient-information-panel panel-collapse collapse in">
            <div class="panel-body">

                {{ form_errors(form) }}

                {#{{ form_widget(form.id) }}#}
                {{ form_row(form.id) }}

                {#Master radio#}
                {% if formtype == 'merge' %}
                    {#<input type="radio" name="gender" value="male"> Male<br>#}
                    <p>
                    <div class="row">
                        <div class="col-xs-6" align="right">
                            <label>Master Merge Record:</label>
                        </div>
                        <div class="col-xs-6" align="left">
                            <input type="radio" name="calllog-patient-master-record" value="{{ form.vars.value.id }}" class="calllog-patient-id-radio">
                        </div>
                    </div>
                    </p>
                {% endif %}

                <div class="calllog-search-fields">

                    {% for mrn in form.mrn %}
                        {#{% if mrn.status == 'valid' or not mrn.vars.value.field %}#}
                            {{ formmacros.field(mrn.keytype) }}
                            {{ formmacros.field(mrn.field) }}
                        {#{% endif %}#}
                    {% endfor %}

                    {% for dob in form.dob %}
                        {{ formmacros.fieldDateLabel(dob.field,'regular-datepicker') }}
                    {% endfor %}

                    {% set status = 'Submitted' %}

                    {% set encounterPatientInfo = null %}
                    {% set readonlyEncounter = false %}
                    {#{% set encounterEncounterInfo = null %}#}
                    {% for encounter in form.encounter %}
                        {% if encounter.vars.value.status == 'invalid'  %}
                            {% set encounterPatientInfo = encounter %}
                        {% else %}
                            {#{% set encounterEncounterInfo = encounter %}#}
                        {% endif %}
                        {% if encounter.vars.value.id %}
                            {% set readonlyEncounter = true %}
                        {% endif %}
                    {% endfor %}

                    {% if encounterPatientInfo is defined and encounterPatientInfo %}
                        <div class="alias-group">
                            {{ formmacros.inputArrayField(encounterPatientInfo.patlastname,cycle,"encounterpatlastname","","","","",status) }}
                            {{ formmacros.inputArrayField(encounterPatientInfo.patfirstname,cycle,"encounterpatfirstname","","","","",status) }}
                        </div>
                    {% endif %}

                </div>

                {#<a class="collapsed" role="button" data-toggle="collapse" href="#encounter-info">Encounter Info Test</a>#}
                <div id="encounter-info" class="panel-collapse collapse">
                    {% if encounterPatientInfo is defined and encounterPatientInfo %}

                        {{ form_row(encounterPatientInfo.status) }}

                        <div class="alias-group">
                            {{ formmacros.inputArrayField(encounterPatientInfo.patmiddlename,cycle,"encounterpatmiddlename","","","","",status) }}
                            {{ formmacros.inputArrayField(encounterPatientInfo.patsuffix,cycle,"encounterpatsuffix","","","","",status) }}
                        </div>
                        {{ formmacros.inputArrayField(encounterPatientInfo.patsex,cycle,"encounterpatsex","","","","",status) }}

                    {% endif %}
                </div>

                {% if readonlyEncounter %}
                    {% set reenterPatientIdPrefix = "_always_hidden" %}
                {% else %}
                    {% set reenterPatientIdPrefix = "" %}
                {% endif %}

                <div class="row">
                    <div class="col-xs-5"></div>
                    <div class="col-xs-2">
                        <button id="search_patient_button" type="button"
                                class="btn btn-lg btn-success span4" align="center"
                                onclick="findCalllogPatient('{{ holderId }}','{{ formtype }}')" style="float:left; min-width:100%"
                        >Find Patient</button>
                        <button
                                id="reenter_patient_button{{ reenterPatientIdPrefix }}" type="button"
                                class="btn btn-lg btn-success span4" align="center"
                                onclick="clearCalllogPatient('{{ holderId }}')" style="float:left; min-width:100%; display:none;"
                        >Re-enter Patient</button>
                    </div>
                    {% if formtype == 'call-entry' %}
                        <div class="col-xs-3">
                            <button
                                    id="addnew_patient_button" type="button"
                                    class="btn btn-lg btn-success span4" align="center"
                                    onclick="addnewCalllogPatient('{{ holderId }}')" style="float:left; min-width:100%; display:none;"
                            >Add New Patient Registration</button>
                        </div>
                        <div class="col-xs-3">
                            <button
                                    id="edit_patient_button" type="button"
                                    class="btn btn-lg btn-success span4" align="center"
                                    onclick="editPatientBtn('{{ holderId }}')" style="float:left; min-width:100%; display:none;"
                            >Edit Patient Info</button>
                        </div>
                    {% endif %}
                    <div class="col-xs-5"></div>
                </div>

                <br>

                <div id="calllog-danger-box" class="alert alert-danger" style="display: none; margin-top: 5px;"></div>

                <div id="calllog-matching-patients" style="display: none; margin-top: 5px;"></div>

            </div> <!-- panel-body -->
        </div> <!-- panel-collapse -->
    </div> <!-- panel panel-info -->

    </div>

{% endmacro %}


{#TODO: change "Location Name" to be a Select2 dropdown list of all locations filtered by Location type = "Encounter Location"#}
{#Selecting the Encounter Location from the dropdown should load all of its corresponding values into the other fields of this accordion (phone number, etc) via AJAX.#}
{% macro trackerContactinfoForm( entity, cycle, status ) %}

    {% if entity.vars.value.id %}
        {% set orderUniqueId = entity.vars.value.id %}
    {% else %}
        {% set orderUniqueId = 0 %}
    {% endif %}

    {% if entity.tracker.spots is defined and entity.tracker.spots|length > 0 %}
        {% import "OlegUserdirectoryBundle::Default/usermacros.html.twig" as usermacros %}
        {% import "OlegCallLogBundle::Default/calllogmacros.html.twig" as calllogmacros %}

        {% set sitename = 'scan' %}
        {% set currentUser = app.security.getToken().getUser() %}
        {% set counter = 0 %}

        {% for spot in entity.tracker.spots %}
            <div class="panel panel-default">

                <div class="panel-heading">

                    {% set uniqueId = orderUniqueId~"_"~counter %}

                    {#<button#}
                            {#id="form_body_toggle_entitycontactinfo_{{ uniqueId }}" type="button"#}
                            {#class="btn btn-default btn-xs form_body_toggle_btn glyphicon glyphicon-folder-close pull-left"#}
                            {#onclick="calllogToggleSingleEncounterPanel(this,'#form_body_entitycontactinfo_{{ uniqueId }}');">#}
                    {#</button>#}

                    {% set panelTitle = spot.currentLocation.vars.value.name %}
                    {% if not panelTitle %}
                        {% set panelTitle = "Encounter's Location" %}
                    {% endif %}

                    <h4 class="panel-title">
                        {#{% if cycle != 'show' %}#}
                            {#<a#}
                                {#href="javascript:;"#}
                                {#onclick="calllogToggleSingleEncounterPanel(this,'#form_body_entitycontactinfo_{{ uniqueId }}');"#}
                            {#>#}
                                {#{{ panelTitle }}#}
                            {#</a>#}
                        {#{% else %}#}
                            <a class="calllog-patient-panel-title" data-toggle="collapse" href="#form_body_entitycontactinfo_{{uniqueId}}">
                                {{ panelTitle }}
                            </a>
                        {#{% endif %}#}
                    </h4>
                </div>

                <div id="form_body_entitycontactinfo_{{ uniqueId }}" class="panel-body collapse">
                    {#{{ usermacros.locationObject(spot.currentLocation,cycle,'user-locations','noprototype',sitename,currentUser,'editable') }}#}
                    {{ calllogmacros.locationSimpleObject(entity,spot.currentLocation,cycle,'user-locations','noprototype',sitename,currentUser,'editable') }}
                </div>
            </div>

            {% set counter = counter + 1 %}
        {% endfor %}
    {% else %}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">Encounter's Location Not Provided</h4>
            </div>
            <div id="form_body_entitycontactinfo_{{ orderUniqueId }}" class="panel-body collapse">
            </div>
        </div>
    {% endif %}
{% endmacro %}

{% macro updatePatientInfoSection( encounter, cycle, status ) %}
    {% if cycle != "show" and not encounter.vars.value.id %}
        {% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a class="calllog-patient-panel-title" data-toggle="collapse" href="#form_body_encounterInfo">
                        Update Patient Info
                    </a>
                </h4>
            </div>
            <div id="form_body_encounterInfo" class="panel-collapse collapse">
                <div class="panel-body">
                    <div id="calllog-encounterInfo-holder">
                        {{ formmacros.inputArrayField(encounter.patlastname,cycle,"encounterpatlastname","","","","",status) }}
                        {{ formmacros.inputArrayField(encounter.patfirstname,cycle,"encounterpatfirstname","","","","",status) }}
                        {{ formmacros.inputArrayField(encounter.patmiddlename,cycle,"encounterpatmiddlename","","","","",status) }}
                        {{ formmacros.inputArrayField(encounter.patsuffix,cycle,"encounterpatsuffix","","","","",status) }}
                        {{ formmacros.inputArrayField(encounter.patsex,cycle,"encounterpatsex","","","","",status) }}
                        {#{{ formmacros.field(encounter.patientDob) }}#}
                        {{ formmacros.fieldDateLabel(encounter.patientDob,'regular-datepicker') }}
                    </div>
                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-default -->
    {% endif %}
{% endmacro %}

{% macro locationSimpleObject( encounter, field, cycle, classname, prototype, sitename, entity, editable ) %}
    {% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}
    {% import "OlegUserdirectoryBundle::Default/usermacros.html.twig" as usermacros %}

    {% if prototype == "prototype" %}
        {% set formfield = field.vars.prototype %}
    {% else %}
        {% set formfield = field %}
    {% endif %}

    {{ formmacros.field(formfield.id) }}

    {% if encounter.locationName is defined %}
        {{ formmacros.field(encounter.locationName) }}
        <div style="display: none">
            {{ formmacros.field(formfield.name) }}
        </div>
    {% else %}
        {{ formmacros.field(formfield.name) }}
    {% endif %}

    {% if formfield.locationTypes is defined %}
        {{ formmacros.field(formfield.locationTypes) }}
    {% endif %}

    {{ usermacros.emailPhoneField(formfield.phone,cycle,'phone',"") }}

    {% if formfield.room is defined %}
        {{ formmacros.field_notempty(formfield.room,cycle) }}
    {% endif %}

    {% if formfield.suite is defined %}
        {{ formmacros.field_notempty(formfield.suite,cycle) }}
    {% endif %}

    {% if formfield.floor is defined %}
        {{ formmacros.field(formfield.floor) }}
    {% endif %}

    {% if formfield.floorSide is defined %}
        {{ formmacros.field(formfield.floorSide) }}
    {% endif %}

    {{ formmacros.field(formfield.building) }}

    {{ usermacros.geoLocation(formfield,cycle,prototype) }}

    {{ formmacros.field_notempty(formfield.comment,cycle) }}

{% endmacro %}


{% macro referingProviderObject( encounter, cycle, classname, prototype ) %}

    {% if encounter and encounter.referringProviders is defined and encounter.referringProviders|length > 0 %}

        {% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}

        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#calllog-Referring-Provider-{{ encounter.vars.value.id }}">
                        Referring Provider
                    </a>
                </h4>
            </div>
            <div id="calllog-Referring-Provider-{{ encounter.vars.value.id }}" class="panel-collapse collapse in">
                <div class="panel-body">

                        {#{{ formmacros.inputArrayField(encounter.referringProviders,cycle,"encounterreferringprovider","","","","",status) }}#}
                        {% for referringProvider in encounter.referringProviders %}
                            {#{{ formmacros.field_show_user( encounter, "referringProviders", cycle ) }}#}
                            {{ formmacros.field(referringProvider.field) }}
                            {{ formmacros.field(referringProvider.referringProviderSpecialty) }}
                            {{ formmacros.field(referringProvider.referringProviderPhone) }}
                            {{ formmacros.field(referringProvider.referringProviderEmail) }}
                        {% endfor %}

                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-primary -->

    {% endif %}

{% endmacro %}

{#message is an entity#}
{% macro calllogAuthors( message, cycle, sitename ) %}

    {% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}

    <div class="panel panel-primary">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" href="#calllog-Authors">
                    {% if message.version|number_format > 1 %}
                        Authors
                    {% else %}
                        Author
                    {% endif %}
                </a>
            </h4>
        </div>
        <div id="calllog-Authors" class="panel-collapse collapse in">
            <div class="panel-body">

                {#Submitter#}
                {% set authorHref = path(sitename~'_showuser',{'id':message.provider.getId()}) %}
                {% set hreflink = '<a target="_blank" href="'~authorHref|raw~'">'~message.provider.getUsernameOptimal()~'</a>' %}
                {{ formmacros.simplefield( "Submitter:", hreflink, "", "disabled" ) }}

                {#Submitted on#}
                {{ formmacros.simplefield("Submitted on:", user_service_utility.getOrderDateStr(message), "", "disabled") }}

                {#Message Status#}
                {{ formmacros.simplefield("Message Status:", message.messageStatus.name, "", "disabled") }}
                {% if message.messageStatus.name == "Signed" and message.signeeInfo %}
                    {% if message.signeeInfo.modifiedBy %}
                        {% set authorHref = path(sitename~'_showuser',{'id':message.signeeInfo.modifiedBy.getId()}) %}
                        {% set hreflink = '<a target="_blank" href="'~authorHref|raw~'">'~message.signeeInfo.modifiedBy.getUsernameOptimal()~'</a>' %}
                        {{ formmacros.simplefield( "Signed by:", hreflink, "", "disabled" ) }}
                    {% endif %}
                    {% if message.signeeInfo.modifiedOn %}
                        {% set signedDate = message.signeeInfo.modifiedOn|date('m/d/Y') ~ " at " ~ message.signeeInfo.modifiedOn|date('h:i a (T)') %}
                        {{ formmacros.simplefield("Signed on:", signedDate, "", "disabled") }}
                    {% endif %}
                    {% if message.signeeInfo.modifierRoles|length > 0 %}
                        {% set signeeRoles = user_security_utility.getRolesByRoleNames(message.signeeInfo.modifierRoles) %}
                        {{ formmacros.simplefield("Signee role(s) at signature time:", signeeRoles, "", "disabled") }}
                    {% else %}
                        {{ formmacros.simplefield("Signee role(s) at signature time:", "No roles", "", "disabled") }}
                    {% endif %}
                {% endif %}

                {#IF "Message Version">1 (2 or more), display the following three fields:#}
                {% if message.version|number_format > 1 %}
                    {% set lastEditorInfo = message.getEditorInfos()|last %}
                    {% if lastEditorInfo %}
                        {% if lastEditorInfo.modifiedBy %}
                            {% set authorHref = path(sitename~'_showuser',{'id':lastEditorInfo.modifiedBy.getId()}) %}
                            {% set hreflink = '<a target="_blank" href="'~authorHref|raw~'">'~lastEditorInfo.modifiedBy.getUsernameOptimal()~'</a>' %}
                            {{ formmacros.simplefield( "Last edited by:", hreflink, "", "disabled" ) }}
                        {% endif %}
                        {% if lastEditorInfo.modifiedOn %}
                            {% set editedDate = lastEditorInfo.modifiedOn|date('m/d/Y') ~ " at " ~ lastEditorInfo.modifiedOn|date('h:i a (T)') %}
                            {{ formmacros.simplefield("Last edited on:", editedDate, "", "disabled") }}
                        {% endif %}
                        {% if lastEditorInfo.modifierRoles|length > 0 %}
                            {% set editorRoles = user_security_utility.getRolesByRoleNames(lastEditorInfo.modifierRoles) %}
                            {{ formmacros.simplefield("Editor role(s) at edit submission time:", editorRoles, "", "disabled") }}
                        {% else %}
                            {{ formmacros.simplefield("Editor role(s) at edit submission time:", "No roles", "", "disabled") }}
                        {% endif %}
                    {% endif %}
                {% endif %}

            </div> <!-- panel-body -->
        </div> <!-- panel-collapse -->
    </div> <!-- panel panel-primary -->

{% endmacro %}

{% macro indexAction( message, eventObjectTypeId, patientListId, cycle ) %}

    <!-- Modal -->
    {#<div class="modal fade" id="addComment_{{ message.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">#}
        {#<div class="modal-dialog">#}
            {#<div class="modal-content">#}
                {#<div class="modal-header">#}
                    {#<button type="button" class="close comment_modal_close" data-dismiss="modal" aria-hidden="true">&times;</button>#}
                    {#<h4 class="modal-title text-center" id="myModalLabel">Add Comment for Entry {{ message.id }}</h4>#}
                {#</div>#}
                {#<div class="modal-body">#}

                    {#<div id="modal_error_{{ message.id }}" class="modal_error_div"></div>#}

                    {#<form id="addcomment_form">#}


                        {#<select id="modal-processor-comment" class="combobox">#}
                            {#<option></option>#}
                            {#<option value="Let's Discuss this at signout">Let's Discuss this at signout</option>#}
                            {#<option value="Relevant resources">Relevant resources</option>#}
                            {#<option value="Please complete this entry">Please complete this entry</option>#}
                        {#</select>#}

                        {#<br>#}
                        {#<br>#}


                        {#<div class="row">#}
                            {#<div class="col-xs-12">#}

                                {#<p>#}

                                    {#<input type="hidden" id="baseurl" value="c.med.cornell.edu/order" />#}
                                    {#<textarea id="addcomment_text" name="addcomment" type="textarea" class="textarea form-control" maxlength="5000" required></textarea>#}
                                {#</p>#}

                            {#</div>#}
                        {#</div>#}

                        {#<div class="center-block">#}
                            {#<input id="AddNewComment" class="btn btn-primary center-block" type="button" value="Add Comment" onclick="submitNewComment({{ message.id }});" />#}
                        {#</div>#}

                    {#</form>#}

                {#</div>#}
            {#</div>#}
        {#</div>#}
    {#</div>#}
    <!-- EOF Modal -->


    <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            Action <span class="caret"></span>
        </button>


        <ul class="dropdown-menu dropdown-menu-right">

            {% if message.messageStatus and message.messageStatus.name == "Draft" %}
                <li><a href="#">Edit Entry</a></li>
            {% else %}
                <li><a href="#">Amend</a></li>
            {% endif %}

            {% if message.messageStatus and message.messageStatus.name != "Deleted" %}
                {#Are you sure you would like to delete entry 123 for patient FirstName LastName (MRN Type: MRN)?#}
                <li><a
                    data-confirm="Are you sure you would like to delete entry {{message.id}} for patient {{message.getPatientNameMrnInfo}}?"
                    href="{{ path('calllog_delete', {'messageId': message.id}) }}"
                    >Delete Entry</a></li>
            {% endif %}
            {% if message.messageStatus and message.messageStatus.name == "Deleted" %}
                {#Are you sure you would like to undelete entry 123 for patient FirstName LastName (MRN Type: MRN)?#}
                <li><a
                    data-confirm="Are you sure you would like to undelete entry {{message.id}} for patient {{message.getPatientNameMrnInfo}}?"
                    href="{{ path('calllog_undelete', {'messageId': message.id}) }}">Undelete Entry</a></li>
            {% endif %}

            <li><a href="{{ path('calllog_event-log-per-object_log', { 'filter[objectType][]': eventObjectTypeId, 'filter[objectId]': message.id}) }}" target="_blank">View Event Log</a></li>

            {% if message.patient|length > 0 %}
                {% set mrn = message.patient|first.obtainValidField('mrn') %}
                {% if mrn and mrn.field and mrn.keytype %}
                    {% set mrnNumber = mrn.field %}
                    {% set mrnTypeId = mrn.keytype.id %}
                    {% if mrnNumber and mrnTypeId %}
                        <li><a href="{{ path('calllog_callentry', { 'mrn': mrnNumber, 'mrn-type': mrnTypeId}) }}" target="_blank">Add Entry (New Encounter)</a></li>

                        <li><a href="{{ path('calllog_callentry', { 'mrn': mrnNumber, 'mrn-type': mrnTypeId, 'message-type': message.messageCategory.id}) }}" target="_blank">Add Entry (New Encounter, Same Type)</a></li>

                        <li><a href="{{ path('calllog_patient_edit_by_mrn', { 'mrn': mrnNumber, 'mrntype': mrnTypeId}) }}" target="_blank">Edit Patient Record</a></li>

                        <li><a href="{{ path('calllog_merge_patient_records', { 'mrn': mrnNumber, 'mrntype': mrnTypeId}) }}" target="_blank">Merge Patient Record</a></li>

                        {% if message.patient|first.obtainMergeMrnArr('valid')|length > 0 %}
                            <li><a href="{{ path('calllog_unmerge_patient_records', { 'mrn': mrnNumber, 'mrntype': mrnTypeId}) }}" target="_blank">Un-merge Patient Record</a></li>
                        {% endif %}
                    {% endif %}
                {% endif %}

                <li><a data-confirm="Are you sure you want to add this patient to Complex List?"
                       href="{{ path('calllog_add_patient_to_list', { 'patientListId': patientListId, 'patientId': message.patient|first.id}) }}"
                       target="_blank">Add to Complex List</a>
                </li>
            {% endif %}

            {% set validEncounter = message.getValidEncounter %}
            {% if validEncounter %}

                {% set locationId = validEncounter.obtainTrackerSpotsLocationId %}
                {% if locationId %}
                    <li><a href="{{ path('employees_locations_pathaction_edit_standalone', { 'id': locationId}) }}" target="_blank">Edit Encounter Location</a></li>
                {% endif %}

                {#Edit Referring Provider Profile#}
                {% for referringProvider in validEncounter.getReferringProviders %}
                    {% if referringProvider %}
                        {% set linkedUser = referringProvider.obtainLinkedUser %}
                        {% set linkedUserId = null %}
                        {% if linkedUser %}
                            {% set linkedUserId = linkedUser.getId() %}
                        {% endif %}
                        {% if linkedUserId %}
                            <li><a href="{{ path('calllog_user_edit', { 'id': referringProvider.obtainLinkedUser.getId}) }}" target="_blank">Edit Referring Provider Profile</a></li>
                        {% else %}
                            {% if referringProvider.getField and referringProvider.getField.getId %}
                                <li><a href="{{ path('userwrappers_edit', { 'id': referringProvider.getField.getId}) }}" target="_blank">Edit Referring Provider Profile</a></li>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endfor %}

            {% endif %}

            {#TODO: Add Entry (Same Encounter) and Add Entry (Same Encounter & Type)#}
            {#Same Encounter#}
            {#{% if message.patient|length > 0 %}#}
                {#{% set mrn = message.patient|first.obtainValidField('mrn') %}#}
                {#{% if mrn %}#}
                    {#{% set mrnNumber = mrn.field %}#}
                    {#{% set mrnTypeId = mrn.keytype.id %}#}

                    {#{% set validEncounter = message.getValidEncounter() %}#}
                    {#{% set validEncounterNumber = validEncounter.obtainValidField('number') %}#}
                    {#{% set encounterNumber = validEncounterNumber.field %}#}
                    {#{% set encounterTypeId = validEncounterNumber.keytype.id %}#}

                    {#<li><a href="{{ path('calllog_callentry', { 'mrn':mrnNumber, 'mrn-type':mrnTypeId, 'encounter':encounterNumber, 'encounter-type':encounterTypeId}) }}" target="_blank">Add Entry (Same Encounter)</a></li>#}
                {#{% endif %}#}
            {#{% endif %}#}

            {#<li><a href="#">View Entry History & Comments</a></li>#}
            {#<li>#}
                {#<a href="#" data-toggle="modal" data-target="#addComment_{{ message.id }}">Add Comment</a>#}
            {#</li>#}
            {#<li><a data-confirm="Are you sure you want to duplicate data?" data-ok="Duplicate" data-cancel="Do not duplicate" class="action-cancel-status" href="#">Generate new entry for same patient issue</a>#}
            {#</li>#}

        </ul>

    </div>

{% endmacro %}

{#Patient List#}
{% macro calllogPatientList( message, cycle ) %}
    {% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}
    {% import "OlegUserdirectoryBundle::Tree/treemacros.html.twig" as treemacros %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" href="#calllog-PatientList">
                    Patient List
                </a>
            </h4>
        </div>
        <div id="calllog-PatientList" class="panel-collapse collapse in">
            <div class="panel-body">

                {#"Add patient to the list: [v]"#}
                {{ formmacros.checkbox(message.calllogEntryMessage.addPatientToList) }}

                {#List Title:#}
                {#{% if message.calllogEntryMessage.patientList is defined %}#}
                    {{ treemacros.compositeTreeNode(message.calllogEntryMessage.patientList,cycle,"noprototype") }}
                {#{% endif %}#}

            </div> <!-- panel-body -->
        </div> <!-- panel-collapse -->
    </div> <!-- panel panel-default -->
{% endmacro %}


{% macro patientListAction( patient, patientListId ) %}

    <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            Action <span class="caret"></span>
        </button>

        <ul class="dropdown-menu dropdown-menu-right">

            {% set mrn = patient.obtainValidField('mrn') %}
            {% if mrn and mrn.field and mrn.keytype %}
                {% set mrnNumber = mrn.field %}
                {% set mrnTypeId = mrn.keytype.id %}
                {% if mrnNumber and mrnTypeId %}
                    <li><a href="{{ path('calllog_home', { 'filter[search]': mrnNumber}) }}"
                           target="_blank">Show all entries</a>
                    </li>

                    <li><a href="{{ path('calllog_patient_edit_by_mrn', { 'mrn': mrnNumber, 'mrntype': mrnTypeId}) }}"
                           target="_blank">Edit Patient Record</a>
                    </li>

                    <li><a href="{{ path('calllog_merge_patient_records', { 'mrn': mrnNumber, 'mrntype': mrnTypeId}) }}"
                           target="_blank">Merge Patient Record</a>
                    </li>

                    {% if patient.obtainMergeMrnArr('valid')|length > 0 %}
                        <li><a href="{{ path('calllog_unmerge_patient_records', { 'mrn': mrnNumber, 'mrntype': mrnTypeId}) }}"
                               target="_blank">Un-merge Patient Record</a>
                        </li>
                    {% endif %}
                {% endif %}

                <li><a data-confirm="Are you sure you want to remove this patient from this list?"
                       href="{{ path('calllog_remove_patient_from_list', { 'patientId': patient.id, 'patientListId': patientListId }) }}"
                       target="_blank">Remove patient from this list</a>
                </li>


            {% endif %}

        </ul>

    </div>

{% endmacro %}
