{% extends "OlegCallLogBundle::Default/base.html.twig" %}

{% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}
{% import "OlegUserdirectoryBundle::Default/usermacros.html.twig" as usermacros %}
{% import "OlegCallLogBundle::Default/calllogmacros.html.twig" as calllogmacros %}


{% block title %}
    {{ title }}
{% endblock %}


{% block content %}

    <h4 class="text-info" align="center">
        {{ title }}
    </h4>

    <br>

    <div class="calllog-holder">
    <input type="hidden" id="formcycle" value="{{ cycle }}" />
    <input type="hidden" id="orderformtype" value="calllog" />

    {#<form id="CallCaseForm" class="form-vertical" role="form">#}
    {{ form_start(form,{'attr': {'id': 'calllog-entry-form'}}) }}

        {{ form_errors(form) }}

        <div class="panel panel-primary">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#calllog-PatientInformation">
                        Patient Info
                    </a>
                </h4>
            </div>
            <div id="calllog-PatientInformation" class="panel-collapse collapse in">
                <div class="panel-body">

                    {% for mrn in form.mrn %}
                        {{ formmacros.field(mrn.keytype) }}
                        {{ formmacros.field(mrn.field) }}
                    {% endfor %}

                    {% for dob in form.dob %}
                        {{ formmacros.fieldDateLabel(dob.field,'regular-datepicker') }}
                    {% endfor %}

                    {% set status = 'Submitted' %}

                    {% for encounter in form.encounter %}
                        {{ formmacros.inputArrayField(encounter.patlastname,cycle,"encounterpatlastname","","","","",status) }}
                        {{ formmacros.inputArrayField(encounter.patfirstname,cycle,"encounterpatfirstname","","","","",status) }}
                    {% endfor %}

                    <a class="collapsed" role="button" data-toggle="collapse" href="#encounter-info">Encounter Info Test</a>
                    <div id="encounter-info" class="panel-collapse collapse">
                    {% for encounter in form.encounter %}

                        {#{{ formmacros.field(encounter.patlastname) }}#}
                        {#{{ formmacros.field(encounter.patfirstname) }}#}
                        {#{{ formmacros.field(encounter.patmiddlename) }}#}
                        {#{{ formmacros.field(encounter.patsuffix) }}#}
                        {#{{ formmacros.field(encounter.patsex) }}#}

                        {#{{ formmacros.inputArrayField(encounter.patlastname,cycle,"encounterpatlastname","","","","",status) }}#}
                        {#{{ formmacros.inputArrayField(encounter.patfirstname,cycle,"encounterpatfirstname","","","","",status) }}#}
                        {{ formmacros.inputArrayField(encounter.patmiddlename,cycle,"encounterpatmiddlename","","","","",status) }}
                        {{ formmacros.inputArrayField(encounter.patsuffix,cycle,"encounterpatsuffix","","","","",status) }}
                        {{ formmacros.inputArrayField(encounter.patsex,cycle,"encounterpatsex","","","","",status) }}

                    {% endfor %}
                    </div>


                    {#<div class="row">#}

                        {#<div class="form-group col-xs-5" align="left">#}
                            {#{{ formmacros.simplefield('MRN:','','input') }}#}
                            {#{{ formmacros.simplefield('Last Name:','','input') }}#}

                            {#{{ formmacros.field(form.mrn) }}#}
                            {#{{ formmacros.field(form.lastname) }}#}

                        {#</div>#}

                        {#<div class="col-xs-5" align="left">#}
                            {#{{ calllogmacros.simpleDateField('Date of Birth:','') }}#}
                            {#{{ formmacros.simplefield('First Name:','','input') }}#}
                        {#</div>#}

                        {#<div class="col-xs-2" align="left">#}
                            {#<button id="Search_button" type="button" class="btn btn-lg btn-success" align="center" style="float:left; width:100%">Search</button>#}
                        {#</div>#}

                    {#</div>#}

                    <div class="row">
                        <div class="col-xs-5"></div>
                        <div class="col-xs-2">
                            <button id="Search_button" type="button"
                                    class="btn btn-lg btn-success" align="center"
                                    onclick="findCalllogPatient()"
                                    style="float:left; width:100%">Find Patient</button>
                        </div>
                        <div class="col-xs-5"></div>
                    </div>

                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-info -->

        <a class="collapsed" role="button" data-toggle="collapse" href="#callentry-form">
            No single patient is referenced by this entry or I'll add the patient info later
        </a>
        <div id="callentry-form" class="panel-collapse collapse">

        <div class="panel panel-primary">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#calllog-CallInformation">
                        Call Information
                    </a>
                </h4>
            </div>
            <div id="calllog-CallInformation" class="panel-collapse collapse in">
                <div class="panel-body">

                    <div class="row">

                        <div class="form-group col-xs-5" align="left">
                            {#{{ formmacros.simplefield('Service:','','input') }}#}
                            <p>
                            <div class="row">
                                <div class="col-xs-6" align="right">
                                    <label>Service:</label>
                                </div>
                                <div class="col-xs-6" align="left" class="form_body_toggle_btn">
                                    <select id="Service" name="Service" class="combobox" style="float:right;width: 70%">
                                        <option value="All">Transfusion Medicine</option>
                                        <option value="Microbiology">Microbiology</option>
                                        <option value="Chemistry">Chemistry</option>
                                        <option value="Coagulation">Coagulation</option>
                                        <option value="Hematology">Hematology</option>
                                        <option value="Molecular">Molecular</option>
                                        <option value="Cytogenetics">Cytogenetics</option>
                                    </select>
                                </div>
                            </div>
                            </p>

                            {#{{ formmacros.simplefield('Issue:','','input') }}#}
                            <p>
                            <div class="row">
                                <div class="col-xs-6" align="right">
                                    <label>Issue:</label>
                                </div>
                                <div class="col-xs-6" align="left" class="form_body_toggle_btn">
                                    <select id="Service" name="Service" class="combobox" style="float:right;width: 70%">
                                        <option value="First dose plasma">First dose plasma</option>
                                        <option value="First dose platelets ">First dose platelets </option>
                                        <option value="Third+ dose platelets">Third+ dose platelets</option>
                                        <option value="Cryoprecipitate">Cryoprecipitate</option>
                                        <option value="MTP">MTP</option>
                                        <option value="Emergency release">Emergency release</option>
                                        <option value="Payson transfusion">Payson transfusion</option>
                                        <option value="Incompatible crossmatch">Incompatible crossmatch</option>
                                        <option value="Transfusion reaction"> <a data-toggle="collapse" href="#TrfnRxnForm">Transfusion reaction</a></option>
                                        <option value="Complex platelet summary">Complex platelet summary</option>
                                        <option value="Complex factor summary">Complex factor summary</option>
                                        <option value="WinRho">WinRho</option>
                                        <option value="Special needs">Special needs</option>
                                        <option value="Antibiotic sensitivity approval">Antibiotic sensitivity approval</option>
                                        <option value="Viracor testing">Viracor testing</option>
                                        <option value="Critical Value">Critical Value</option>
                                        <option value="Aberrant analyte ">Aberrant analyte </option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            </p>


                        </div>

                        <div class="form-group col-xs-5" align="left">
                            {{ calllogmacros.simpleDateField('Date:','') }}
                            {{ formmacros.simplefield('Location:','','input') }}
                        </div>

                        <div class="form-group col-xs-2" align="left">
                        </div>

                    </div>

                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-info -->


        <div class="panel panel-primary">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#calllog-HistoryFindings">
                        History/Findings
                    </a>
                </h4>
            </div>
            <div id="calllog-HistoryFindings" class="panel-collapse collapse in">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-12" align="left">
                            <textarea rows="4" class="textarea form-control input-lg" placeholder="Free text entry describing the call."></textarea>
                        </div>
                    </div>
                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-info -->

        <div class="panel panel-primary">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#calllog-ImpressionOutcome">
                        Impression/Outcome
                    </a>
                </h4>
            </div>
            <div id="calllog-ImpressionOutcome" class="panel-collapse collapse in">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-12" align="left">
                            <textarea rows="4" class="textarea form-control input-lg" placeholder="Free text entry."></textarea>
                        </div>
                    </div>
                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-info -->

        <p>
            <button class="btn btn-lg btn-primary btn-success" name="btnSubmit" type="submit">Submit</button>
        </p>

        </div> {#callentry-form#}

    {#</form>#}
    {{ form_end(form,{'render_rest': false}) }}


    </div>

{% endblock %}


{% block additionaljs %}
<script language="Javascript">

    $(document).ready(function() {



    });

    function findCalllogPatient() {

        var mrntype = $(".mrntype-combobox").select2('val');
        mrntype = trimWithCheck(mrntype);

        var mrn = $(".patientmrn-mask").val();
        mrn = trimWithCheck(mrn);

        var dob = $(".patient-dob-date").val();
        dob = trimWithCheck(dob);

        var lastname = $(".encounter-lastName").val();
        lastname = trimWithCheck(lastname);

        var firstname = $(".encounter-firstName").val();
        firstname = trimWithCheck(firstname);

        console.log('mrntype='+mrntype+", mrn="+mrn+", dob="+dob+", lastname="+lastname+", firstname="+firstname);

        //ajax
        var url = Routing.generate('calllog_search_patient');
        $.ajax({
            url: url,
            timeout: _ajaxTimeout,
            async: false,
            data: {mrntype: mrntype, mrn: mrn, dob: dob, lastname: lastname, firstname: firstname },
        }).success(function(data) {
            console.log(data);
            if( data.length > 0 ) {
                console.log(data);
                populatePatientsInfo(data);
            } else {
                populatePatientInfo(null);
                console.log("Patient not found");
            }
        });

    }

    function populatePatientsInfo(patients) {
        populatePatientInfo(patients[0]);
    }

    function populatePatientInfo(data) {

        var dob = null;
        var lastname = null;
        var firstname = null;
        var middlename = null;
        var suffix = null;
        var sex = null;


        if( data && data.dob ) {
            dob = data.dob
        }
        $(".patient-dob-date").val(dob);

        if( data && data.lastname ) {
            lastname = data.lastname;
        }
        $(".encounter-lastName").val(lastname);

        if( data && data.firstname ) {
            firstname = data.firstname;
        }
        $(".encounter-firstName").val(firstname);

        if( data && data.middlename ) {
            middlename = data.middlename;
        }
        $(".encounter-middleName").val(middlename);

        if( data && data.suffix ) {
            suffix = data.suffix;
        }
        $(".patient-suffix").val(suffix);

        if( data && data.sex ) {
            sex = data.sex;
        }
        $(".encountersex-field").val(sex);

        console.log('middlename='+middlename+'; suffix='+suffix+'; sex='+sex);
        if( middlename || suffix || sex  ) {
            $('#encounter-info').collapse("show");
        } else {
            $('#encounter-info').collapse("hide");
        }

    }

</script>
{% endblock %}