{% extends "OlegOrderformBundle::Default/base.html.twig" %}

{% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}

{% import "OlegOrderformBundle::Default/ordercommon.html.twig" as order %}

{% block title %}
    {{ formtype }}
{% endblock %}


{% block maincss %}

    {% stylesheets
    'bundles/olegorderform/handsontable/jquery.handsontable.full.css' filter='cssrewrite'
    'bundles/olegorderform/form/css/handsontable.css' filter='cssrewrite'

    'bundles/oleguserdirectory/select2/select2.css' filter='cssrewrite'
    'bundles/oleguserdirectory/ladda/ladda-themeless.css' filter='cssrewrite'

    'bundles/oleguserdirectory/form/css/action.css' filter='cssrewrite'
    'bundles/olegorderform/handsontable/lib/jquery-ui/css/ui-bootstrap/jquery-ui.custom.css' filter='cssrewrite'

    'bundles/oleguserdirectory/datepicker/css/datepicker3.css' filter='cssrewrite'
    %}
    <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}

{% endblock %}


{% block mainjs %}

    {% javascripts
    '@OlegUserdirectoryBundle/Resources/public/jquery/jquery-1.11.0.min.js'
    '@OlegUserdirectoryBundle/Resources/public/handsontable/lib/jquery-ui/js/jquery-ui.custom.min.js'

    '@OlegOrderformBundle/Resources/public/handsontable/jquery.handsontable.full.js'
    '@OlegOrderformBundle/Resources/public/form/js/handsontable_scanorder.js'
    '@OlegOrderformBundle/Resources/public/form/js/handsontable_validation.js'

    '@OlegUserdirectoryBundle/Resources/public/bootstrap/js/*'
    '@OlegUserdirectoryBundle/Resources/public/ladda/spin.min.js'
    '@OlegUserdirectoryBundle/Resources/public/ladda/ladda.min.js'
    '@OlegUserdirectoryBundle/Resources/public/datepicker/js/bootstrap-datepicker.js'
    '@OlegUserdirectoryBundle/Resources/public/select2/select2.js'
    '@OlegUserdirectoryBundle/Resources/public/inputmask/jquery.inputmask.bundle.js'
	
	'@OlegUserdirectoryBundle/Resources/public/form/js/user-common.js'
    '@OlegUserdirectoryBundle/Resources/public/form/js/user-fileuploads.js'
    '@OlegUserdirectoryBundle/Resources/public/form/js/user-navbar.js'

    '@OlegUserdirectoryBundle/Resources/public/form/js/user-selectAjax.js'
    '@OlegUserdirectoryBundle/Resources/public/form/js/user-treeSelectAjax.js'

    '@OlegOrderformBundle/Resources/public/form/js/checkSingleForm.js'
    '@OlegOrderformBundle/Resources/public/form/js/slideColl.js'
    '@OlegOrderformBundle/Resources/public/form/js/partRadios.js'
    '@OlegOrderformBundle/Resources/public/form/js/selectAjax.js'
    '@OlegOrderformBundle/Resources/public/form/js/commonCheckForm.js'
    '@OlegOrderformBundle/Resources/public/form/js/checkForm.js'

    '@OlegOrderformBundle/Resources/public/form/js/masking.js'
    '@OlegOrderformBundle/Resources/public/form/js/form.js'
    '@OlegOrderformBundle/Resources/public/form/js/formReady.js'
    '@OlegOrderformBundle/Resources/public/form/js/modal.js'
    '@OlegOrderformBundle/Resources/public/form/js/tooltips.js'


    '@OlegUserdirectoryBundle/Resources/public/idletimeout/jquery.idletimeout.js'
    '@OlegUserdirectoryBundle/Resources/public/idletimeout/jquery.idletimer.js'	
    '@OlegUserdirectoryBundle/Resources/public/form/js/user-idleTimeout.js'
    '@OlegOrderformBundle/Resources/public/form/js/idleTimeout.js'
    
    '@OlegUserdirectoryBundle/Resources/public/vakata-jstree/jstree.min.js'
    '@OlegUserdirectoryBundle/Resources/public/form/js/user-jstree.js'

    '@OlegUserdirectoryBundle/Resources/public/jasny/js/rowlink.js'
    '@OlegUserdirectoryBundle/Resources/public/q-1/q.js'
    %}
    <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script type="text/javascript">

        var _tableFormCycle = '{{ type }}';

        if( '{{ orderdata }}' != '' ) {
            var _orderDataArr = JSON.parse('{{ orderdata|escape('js') }}');
        }
        //console.log("_orderDataArr="+_orderDataArr);

    </script>

    {#FOSJsRoutingBundle#}
    <script src="{{ asset('bundles/fosjsrouting/js/router.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', {'callback': 'fos.Router.setData'}) }}"></script>

{% endblock %}


    
{% block content %}

    {% set showpath = 'table_show' %}
    {% set amendpath = 'table_amend' %}

    {% if amendable is not defined %}
        {% set amendable = false %}
    {% endif %}

    {% if changestatus is not defined %}
        {% set changestatus = false %}
    {% endif %}

    {{ order.orderheader( form, formtype, type, showpath, amendpath, amendable, changestatus ) }}

    {#history#}
    {% if history is defined and history %}
        {{ formmacros.history_info(history,form) }}
    {% endif %}

    {#<input type="hidden" id="formtype" value="multi" />#}
    <input type="hidden" id="orderformtype" value="multi" />
    <input type="hidden" id="formcycle" value="{{ type }}" />

    {% if entity is defined and entity.dataqualitymrnacc|length > 0 %}
        <div class="alert alert-danger">
            <p>This order contained an MRN-Accession Number association that conflicted with an already existing MRN-Accession Number association.</p>
            <a href="#existing_validation_error">Please see the note below for details.</a>
        </div>
    {% endif %}

<br>
    {############ START FORM ##############}
    <form id="table-scanorderform" action="{{ path('table_create_submit') }}" method="post" {{ form_enctype(form) }}>

        {% include 'OlegOrderformBundle::MultiScanOrder/edu_res.html.twig' %}

        {{ form_widget(form.oid) }}

        {% if type == 'show' %}
            {{ formmacros.message_panel(form, "Scan Order Info") }}
        {% endif %}

        <div id="form-prototype-data"
            data-prototype-dataquality = "{{ formmacros.dataQualityWidgetNotMapped(form.conflicts.vars.prototype)|e }}"
            data-uploadurl = "{{ oneup_uploader_endpoint('scan_gallery') }}"
            data-userid = "{{ app.security.getToken().getUser().getId() }}"
        ></div>

        <!-- handsontable -->
        <br>

        <p>
            <div id="multi-dataTable" class="text-center" align="middle" style="overflow: scroll"></div>
        </p>

        <br>

        {#<p>{{ formmacros.message_panel(form,"Order Info") }}</p>#}

        {% if type == 'new' or type == 'edit' or type == 'amend' %}

            <p>{{ formmacros.message_panel(form,"Order Info") }}</p>

            <div class="row">
                {% if type == 'amend' %}

                    <p><button id="scanorder_amend_order_btn" class="btn_margin_top btn btn-primary btn-success tableview-submit-btn" name="btnAmend" data-loading-text="Validating..." type="submit" onClick="saveClick(this.name);">Amend</button></p>

                {% else %}

                    <p><button id="tableview-submit-btn" class="btn_margin_top btn btn-primary btn-success tableview-submit-btn" name="btnSubmit" data-loading-text="Validating..." type="submit" onClick="saveClick(this.name);">Submit</button></p>

                    <p><button id="save_order_onidletimeout_btn" class="btn btn-default" name="btnSaveOnIdleTimeout" type="submit" style="display: none;" onClick="saveClick(this.name);">Save and Continue Later</button></p>

                {% endif %}
            </div>

        {% endif %}

        {% if entity is defined and entity is not null %}
            <div id="existing_validation_error" style="padding-top: 2%">
                {% for dataqualitymrnacc in entity.dataqualitymrnacc %}
                    <div class="alert alert-danger">
                        <br>
                        Conflict Resolved by Replacement:
                        <br>
                        <b>{{ dataqualitymrnacc.accession }}</b> => <b>{{ dataqualitymrnacc.newaccession }}</b>
                        <br>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div id="validationerror" style="padding-top: 2%"></div>


        {{ form_rest(form) }}

    </form>
    {############ END FORM ##############}

{% endblock %}
