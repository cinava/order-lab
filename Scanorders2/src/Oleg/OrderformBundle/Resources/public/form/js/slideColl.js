/**
 * JS for slide coollections
 * Created with JetBrains PhpStorm.
 * User: oli2002
 * Date: 9/10/13
 * Time: 9:11 AM
 * To change this template use File | Settings | File Templates.
 */


//type:       single or multi
//ident:      specialStains or relevantScans
//*Count:     object id
function addCollField( ident, type, patient, specimen, accession, part, block, slide ) {

    var prefix = "oleg_orderformbundle_orderinfotype_";

    //Id Generated by Symfony: oleg_orderformbundle_orderinfotype_patient_0_specimen_0_accession_0_part_0_block_0_slide_0_relevantScans_0_name
    var uid = 'patient_'+patient+'_specimen_'+specimen+'_accession_'+accession+'_part_'+part+'_block_'+block+'_slide_'+slide+'_'+ident;

    //console.log("type="+type);
    if( type == "single" ) {
        //oleg_orderformbundle_slidetype_relevantScans_0_name
        prefix = "oleg_orderformbundle_slidetype_";
        uid = ident;
    }

    //get coll count from id: oleg_orderformbundle_orderinfotype_patient_0_specimen_0_accession_0_part_0_block_0_slide_0_relevantScans_0_name

    //oleg_orderformbundle_orderinfotype_patient_0_specimen_0_accession_0_part_0_block_0_slide_0_relevantScans
    var partialId = prefix + uid ;//+ "_name";
    //console.log("partialId="+partialId);

    var elements = $('[id^='+partialId+']');
    //console.log("elements length="+elements.length);

    var coll = elements.length;
    //console.log("diffdiagInt="+diffdiagInt);

    var newForm = getCollField( ident, patient, specimen, accession, part, block, slide, coll );

    //oleg_orderformbundle_orderinfotype_patient_0_specimen_0_accession_0_part_0_block_0_slide_0_relevantScans_0_name
    var addto = "#" + prefix + uid + "_" + (coll-1) + "_name";
    //console.log("addto="+addto);
    $(addto).after(newForm);

    //add del btn if length == 0
    if( (coll-1) == 0 ) {
        var delbtnId = 'delbtn_patient_'+patient+'_specimen_'+specimen+'_accession_'+accession+'_part_'+part+'_block_'+block+'_slide_'+slide+'_'+ident;
        var addbtnId = 'addbtn_patient_'+patient+'_specimen_'+specimen+'_accession_'+accession+'_part_'+part+'_block_'+block+'_slide_'+slide+'_'+ident;
        var btnDel = '&nbsp;<button id="'+delbtnId+'" onClick="delCollField(\''+ident+'\',' + "\'"+type+"\'," + patient + ',' +specimen+','+accession+','+part+','+block+','+slide+')" class="btn btn-sm btn-danger" type="button">-</button>';
        $("#"+addbtnId).after(btnDel);
    }

    expandTextarea();
}


//add coll input field first time by JS
function addCollFieldFirstTime( ident, ids ) {

    var patient = ids[0];
    var specimen = ids[1];
    var accession = ids[2];
    var part = ids[3];
    var block = ids[4];
    var slide = ids[5];

    //console.log("ident="+ident+",ids="+ids+",patient="+patient+ ",specimen="+specimen+",accession="+accession+",part="+part+",block="+block+",slide="+slide);

    var newForm = getCollField( ident, patient, specimen, accession, part, block, slide, 0 );

    //get addto dimamically: get parent and attach input to this parent
    //id=oleg_orderformbundle_orderinfotype_patient_0_specimen_0_accession_0_part_0_block_0_slide_0_microscopicdescr
    var prevId = 'oleg_orderformbundle_orderinfotype_patient_'+patient+'_specimen_'+specimen+'_accession_'+accession+'_part_'+part+'_block_'+block+'_slide_'+slide+'_microscopicdescr';
    //console.log("prevId="+prevId);

    //get parent
    var parent = $('#'+prevId).parent();
    //console.log( "parent=" + parent.attr('class') );
    var grandParent = parent.parent();
    //console.log( "grandParent="+grandParent.attr('class') );
    //addto = parentId;
    //console.log("1 addto="+addto);

    var delbtnId = 'delbtn_patient_'+patient+'_specimen_'+specimen+'_accession_'+accession+'_part_'+part+'_block_'+block+'_slide_'+slide+'_'+ident;
    var addbtnId = 'addbtn_patient_'+patient+'_specimen_'+specimen+'_accession_'+accession+'_part_'+part+'_block_'+block+'_slide_'+slide+'_'+ident;

    //add button
    var btnAdd = '<button id="'+addbtnId+'" onClick="addCollField(\''+ident+'\',' + "\'multi\'," + patient + ',' +specimen+','+accession+','+part+','+block+','+slide+')" class="btn btn-sm btn-info" type="button">+</button>';
//    var btnDel = '<button id="'+delbtnId+'" onClick="delCollField(\''+ident+'\',' + "\'multi\'," + patient + ',' +specimen+','+accession+','+part+','+block+','+slide+')" class="btn btn-sm btn-danger" type="button">-</button>';

    newForm = newForm + btnAdd;

    var name = "Results of Special Stains:";
    if( ident == "relevantScans" ) {
        name = "Relevant Scanned Images:";
    }

    //create form with bs3 rows
    var finalForm = '<p><div class="row">'+
        '<div class="col-xs-6" align="right">'+
        '<b>'+name+'</b>' +
        '</div>' +
        '<div class="col-xs-6" align="left">' +
        newForm +
        '</div>'+
        '</div></p>';

    //$('#'+addto).after(newForm);
    //$('#'+addto).append(newForm);
    grandParent.after(finalForm);

}

//get input field only
function getCollField( ident, patient, specimen, accession, part, block, slide, coll ) {
    //diffDiagnoses_field_0_0_0_0_0_0_0_0_diffdiag_0
    var dataholder = "#form-prototype-data"; //fixed data holder
    //console.log(dataholder);
    var collectionHolder =  $(dataholder);
    var prototype = collectionHolder.data('prototype-'+ident.toLowerCase());
    //console.log("prototype="+prototype);

    var newForm = prototype.replace(/__patient__/g, patient);
    newForm = newForm.replace(/__specimen__/g, specimen);
    newForm = newForm.replace(/__accession__/g, accession);
    newForm = newForm.replace(/__part__/g, part);
    newForm = newForm.replace(/__block__/g, block);
    newForm = newForm.replace(/__slide__/g, slide);

    var regex = new RegExp( '__' + ident + '__', 'g' );
    newForm = newForm.replace(regex, coll);

    //console.log("newForm="+newForm);
    return newForm;
}


function delCollField( ident, type, patient, specimen, accession, part, block, slide ) {

    console.log("Del: ident="+ident+",type="+type+",patient="+patient+ ",specimen="+specimen+",accession="+accession+",part="+part);

    //Id Generated by Symfony: oleg_orderformbundle_orderinfotype_patient_0_specimen_0_accession_0_part_0_diffDiagnoses_0_name
    var uid = 'patient_'+patient+'_specimen_'+specimen+'_accession_'+accession+'_part_'+part+'_block_'+block+'_slide_'+slide+'_'+ident;

    var prefix = "oleg_orderformbundle_orderinfotype_";

    if( type == "single" ) {
        //oleg_orderformbundle_slidetype_relevantScans_0_name
        prefix = "oleg_orderformbundle_slidetype_";
        uid = ident;
    }

    //ger diffdiag count from id
    var partialId = prefix+uid+"_";
    console.log("partialId="+partialId);

    var elements = $('[id^='+partialId+']');
    //console.log("elements length="+elements.length);

    collInt = elements.length - 1;
    console.log("diffdiagInt="+collInt);

    //check if this field is not he last one
    if( collInt <= 0 ) {
        return false;
    }

    //delete without asking confirmation if the input field is empty
    //remove id: oleg_orderformbundle_orderinfotype_patient_0_specimen_0_accession_0_part_0_diffDiagnoses_1_name
    var delId = partialId+collInt+'_name';
    console.log("delId="+delId);

    var text = $('#'+delId).val();
    //console.log("text="+text);

    if( text == "" ) {

        remDelBtn(ident, type, patient, specimen, accession, part, block, slide, collInt);

        $('#'+delId).remove();
    } else {

        remDelBtn(ident, type, patient, specimen, accession, part, block, slide, collInt);

        if( confirm("Are you sure?") || text == "" ) {
            $('#'+delId).remove();
        }
    }

    return false;
}

function remDelBtn(ident, type, patient, specimen, accession, part, block, slide, collInt) {
    //remove - button for the last field
    console.log("del collInt="+collInt);
    if( collInt == 1 ) {
        var delbtnId = 'delbtn_patient_'+patient+'_specimen_'+specimen+'_accession_'+accession+'_part_'+part+'_block_'+block+'_slide_'+slide+'_'+ident;
        $('#'+delbtnId).remove();
    }
}