<?php

namespace Oleg\OrderformBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * SpecimenRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SpecimenRepository extends EntityRepository
{
    
    //Accession number is the key to check uniqueness 
    public function processEntity( $in_entity, $accession=null ) { 
        
        $em = $this->_em;
        
        if( $accession == null ) {         
            $em->persist($in_entity);
            $em->flush();
            
            return $in_entity;
        }
        
        //if accession exists then return prcedure for this accession; otherwise, create a new
        $accession_found = $em->getRepository('OlegOrderformBundle:Accession')->findOneBy( array(                    
            'accession' => $accession->getAccession()                
        ));
        
        if( $accession_found == null || $accession_found->getSpecimen() == null ) {
            $em->persist($in_entity);
            $em->flush();
            
            return $in_entity;
        }           

        return $accession_found->getSpecimen();
        
    }
    
}
