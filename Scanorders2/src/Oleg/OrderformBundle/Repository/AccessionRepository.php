<?php

namespace Oleg\OrderformBundle\Repository;

//use Doctrine\ORM\EntityRepository;
//use Oleg\OrderformBundle\Entity\Accession;

/**
 * AccessionRepository
 * This class was generated by the Doctrine ORM.
 * Add your own custom repository methods below.
 */
class AccessionRepository extends ArrayFieldAbstractRepository {

    public function setResult( $accession, $orderinfo=null, $original=null ) {
               
        echo "accession=".$accession."<br>";
        $em = $this->_em;
        $em->persist($accession);
                
        if( $orderinfo == null ) {
            return $accession;
        }

        $accession = $this->processFieldArrays($accession,$orderinfo,$original);
        
        $parts = $accession->getPart();
        echo "after process accession=".$accession."<br>";

        foreach( $parts as $part ) {
            if( $em->getRepository('OlegOrderformBundle:Part')->notExists($part,"Part") ) {
//            if(1) {
                $accession->removePart( $part );

                echo "0 accession part name partname=".$part->getPartname()->first()."<br>";
                //echo "0 accession part name partname validity=".$part->getPartname()->first()->getValidity()."<br>";
                echo "0 accession part name partname count=".count($part->getPartname())."<br>";

                $part = $em->getRepository('OlegOrderformBundle:Part')->processEntityPart( $part, $accession, $orderinfo );
                $accession->addPart($part);
                //$orderinfo->addPart($part);
            } else {
                continue;
            }
            $orderinfo->addPart($part);
        }
                  
        //$em->flush($accession);
        echo "finish process accession=".$accession."<br>";
        
        return $accession;
    }

    //filter out duplicate virtual (in form, not in DB) accessions from specimen
    public function removeDuplicateEntities( $specimen ) {

        $accessions = $specimen->getAccession();

//        echo "accession count=".count($accessions)."<br>";
//        exit();
        
        if( count($accessions) == 1 ) {
            return $specimen;
        }

        $accessionNums = array();

        foreach( $accessions as $accession ) {

            //echo "accession=".$accession."<br>";
            $accNum = $accession->getAccession();

            if( count($accessionNums) == 0 || !in_array($accNum, $accessionNums) ) {
                $accessionNums[] = $accNum;
                //persist the rest of entities, because they will be added to DB.
                $em = $this->_em;
                $em->persist($accession);
            } else {
                $specimen->removeAccession($accession);
            }

        }

        return $specimen;
    }

}
?>
