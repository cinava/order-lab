<?php

namespace Oleg\OrderformBundle\Repository;

//use Doctrine\ORM\EntityRepository;

/**
 * ProcedureRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ProcedureRepository extends ArrayFieldAbstractRepository
{

    //Accession number is the key to check uniqueness for Procedure-Accession element
    //input $accessions requires for single slide order, when objects are provided separately and procedure does not have $accessions
    public function processEntityProcedure222( $entity, $accessions=null, $orderinfo=null ) {
        
        //$em = $this->_em;
        //$entity = $em->getRepository('OlegOrderformBundle:Accession')->removeDuplicateEntities( $entity );

//        $accessions = $patient->getAccession();

        echo "accession ID=".$accessions->first()->getId()."<br>";

        //1) can't check uniqueness without accession number
        if( $accessions == null ) {
            echo "******* Procedure Case 1: return cause no accession provided<br>";
            return $this->setResult($entity, $orderinfo);
        }

        //echo "accession count=".count($accessions)."<br>";

        //$accession_found = null;
        //2) if at least one accession belongs to a procedure, then potentially we can use this procedure. Since, currently, Procedure-Accession is one element => procedure has only one accession
        $accession = $accessions->first();

        //$accession = $em->getRepository('OlegOrderformBundle:Patient')->processEntity( $entity, $orderinfo = null, "Accession", "accession", "Part" );

        //check accession
        $foundAccession = $this->isExisted($accession,"Accession","accession");

        if( $foundAccession ) {
            echo "******* Procedure Case 2 & 3: Accession existed in DB<br>";
            //case 2 - existed but empty with STATUS_RESERVED; User press check with empty Key field => new Key was generated
            //Case 3 - existed and STATUS_VALID; User entered existed Key
            $foundProcedure = $foundAccession->getProcedure();

            if( $foundProcedure ) {
                echo "**** Procedure Case 2 & 3: Accession has procedure<br>";
                foreach( $entity->getAccession() as $thisAccession ) {
                    $foundProcedure->addAccession( $thisAccession );
                }
                return $this->setResult( $foundProcedure, $orderinfo, $entity ); //provide found object, cause we need id
            } else {
                echo "**** Procedure Case 2 & 3: Accession does not have procedure, so use procedure provided by form<br>";
                return $this->setResult( $entity, $orderinfo );
            }

        } else {
            echo "******* Procedure Case 4 & 5: Accession does not exists in DB<br>";
            return $this->setResult( $entity, $orderinfo );
        }
    }
    
    public function setResult( $procedure, $orderinfo=null, $original=null ) {

        $em = $this->_em;
        $em->persist($procedure);   
        
        if( $orderinfo == null ) {
            return $procedure;
        }

        //echo "1 procedure name provider=".$procedure->getName()->first()->getProvider()."<br>";
        //echo "1 procedure name validity=".$procedure->getName()->first()->getValidity()."<br>";
        //echo "0 procedure patient MRN=".$procedure->getPatient()->getMrn()->first()."<br>";

        $procedure = $this->processFieldArrays($procedure,$orderinfo,$original);

        $accessions = $procedure->getAccession();
        echo "accession count=".count($accessions)."<br>";
        foreach( $accessions as $accession ) {
            echo $accession;
        }
        
//        foreach( $accessions as $accession ) {
//            //echo $accession;
////            if( $em->getRepository('OlegOrderformBundle:Accession')->notExists($accession, "Accession") ) {
//            if(1) {
//                $procedure->removeAccession( $accession );
//                $accession = $em->getRepository('OlegOrderformBundle:Accession')->processEntity( $accession, $orderinfo, "Accession", "accession", "Part", $procedure );
//                $procedure->addAccession($accession);
//                $accession->setProcedure($procedure);
//                $orderinfo->addAccession($accession);
//            } else {
//                continue;
//            }
//        }

        $accession = $accessions->first();
        $em->persist($accession);
        $parts = $accession->getPart();
        echo "part count=".count($parts)."=>".$parts->first()."<br>";

        //copy accession childs
//        foreach( $entity->getAccession() as $thisAccession ) {
//            $foundProcedure->addAccession( $thisAccession );
//        }

        foreach( $parts as $part ) {
            echo "###<br>".$part."###<br>";
            if( $em->getRepository('OlegOrderformBundle:Part')->notExists($part,"Part") ) {
//            if(1) {
                $accession->removePart( $part );

                echo "0 accession part name partname=".$part->getPartname()->first()."<br>";
                //echo "0 accession part name partname validity=".$part->getPartname()->first()->getValidity()."<br>";
                echo "0 accession part name partname count=".count($part->getPartname())."<br>";

                $part = $em->getRepository('OlegOrderformBundle:Part')->processEntityPart( $part, $accession, $orderinfo );
                $accession->addPart($part);
                //$orderinfo->addPart($part);
            } else {
                continue;
            }
            $orderinfo->addPart($part);
        }


        //echo $procedure."<br>";
        //echo "procedure name provider=".$procedure->getName()->first()->getProvider()."<br>";
        //echo "procedure name validity=".$procedure->getName()->first()->getValidity()."<br>";
//        echo "procedure accession count=".count($procedure->getAccession())."<br>";
//        echo "procedure accession provider=".$procedure->getAccession()->first()->getAccession()->first()->getProvider()."<br>";
//        echo "procedure accession validity=".$procedure->getAccession()->first()->getAccession()->first()->getValidity()."<br>";
//        echo "procedure patient MRN=".$procedure->getPatient()->getMrn()->first()."<br>";

        //exit();
        //$em->flush($procedure);
        return $procedure;
    }

    //TODO: remove MRN check (check procedure only by Accession number)
    //filter out duplicate virtual (in form, not in DB) procedures from provided patient
    public function removeDuplicateEntities( $patient ) {

        $procedures = $patient->getProcedure();
        //echo "procedure count=".count($procedures)."<br>";
        if( count($procedures) <= 1 ) {
            //echo "only 0 or 1 procedure found=".count($procedures)."<br>";
            //exit();
            return $patient;
        }

        //echo "procedure count1=".count($patient->getProcedure())."<br>";

        $count = 0;
        foreach( $procedures as $procedure ) {

            //echo $procedure;

            //1) check if accession is given
            $accessions = $procedure->getAccession();
            if( $accessions == null || count($accessions) == 0 ) {
                //can't check for duplicate without accession => don't remove this procedure => keep this procedure as unique
                //echo "cant check for duplicate without accession <br>";
                continue;
            }

            //2) check if at least one accession belongs to another (second) procedure, then we can potentially use this first procedure and remove the second one.
            $accession_found = null;
            foreach( $accessions as $accession ) {

                //if accession exists then return procedure for this accession; otherwise, create a new
                if( ($count+1) < count($procedures) ) { //make sure index exists and no need to check the last procedure

                    //if( in_array($accession, $procedures[$count+1]->getAccession() ) ) {
                    foreach( $procedures[$count+1]->getAccession() as $accNext ) {
                        //echo "compare: ".$accession->getAccession() ."?". $accNext->getAccession()."<br>";
                        if( $accession->getAccession() == $accNext->getAccession() ) {
                            $accession_found = $accession;
                            break;
                        }
                    }
                }
            }

            $em = $this->_em;

            if( $accession_found == null || $accession_found->getProcedure() == null ) {
                //don't remove
                //echo "no common accessions found <br>";
                //persist the rest of procedures, because they will be added to DB.
                $em->persist($procedure);
            } else {
                //now check if the next procedure (potentially to be removed) has the same MRN, don't check if MRN = "" => new dummy mrn will be generated
                if( $procedure->getPatient()->getMrn() != null && $procedure->getPatient()->getMrn() != "" ) {
                    if( $procedures[$count+1]->getPatient()->getMrn() == $procedure->getPatient()->getMrn() ) {
                        $patient->removeProcedure( $procedures[$count+1] );
                        //echo "remove procedure=".$procedure[$count+1];
                    } else {
                        $em->persist($procedure);
                    }
                }
            }

            $count++;
        }

        //echo "procedure count2=".count($patient->getprocedure())."<br>";
        //exit();

        return $patient;
    }
    
}
