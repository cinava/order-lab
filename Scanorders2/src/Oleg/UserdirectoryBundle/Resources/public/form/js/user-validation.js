/**
 * Created by oli2002 on 9/25/14.
 */

function validateUser(origuserid) {

    var actionFlag = 'new';

    if( typeof origuserid != "undefined" && origuserid != "" ) {
        var actionFlag = 'update';
    }
    //console.log("actionFlag="+actionFlag+", origuserid="+origuserid);

    removeAllErrorAlerts();

    var firstName = $('#oleg_userdirectorybundle_user_firstName').val();
    firstName = trimWithCheck(firstName);
    var lastName = $('#oleg_userdirectorybundle_user_lastName').val();
    lastName = trimWithCheck(lastName);

    if( firstName == "" ) {
        $('#userinfo').collapse('show');
        addErrorAlert("First Name is empty");
        $('#oleg_userdirectorybundle_user_firstName').parent().addClass("has-error");
        return false;
    }

    if( lastName == "" ) {
        $('#userinfo').collapse('show');
        addErrorAlert("Last Name is empty");
        $('#oleg_userdirectorybundle_user_lastName').parent().addClass("has-error");
        return false;
    }

    //check duplicate Username (CWID)
    var autogen = "";
    var cwid = $('#oleg_userdirectorybundle_user_username').val();
    cwid = trimWithCheck(cwid);
    if( cwid == "" ) {
        autogen = "User Name (CWID) field can not be empty. ";
        cwid = "AUTOGENERATED" + "_" + "TEMPORARY" + "_" + lastName + "_" + firstName;
        $('#oleg_userdirectorybundle_user_username').val(cwid);
    }
    var user = checkDuplicateIdentifier(cwid,'cwid');
    var userid = user.id;
    if( userid && (actionFlag == 'new' || userid != origuserid && actionFlag == 'update') ) {

        $('#userinfo').collapse('show');
        $('#oleg_userdirectorybundle_user_username').parent().addClass("has-error");

        var alert = autogen + "An employee with the provided CWID "+cwid+" already exists: " +
            getUserUrl(userid,user.firstName+" "+user.lastName) +
            "Please correct the new employee's CWID or edit the existing employee's information.";
        addErrorAlert(alert);
        return false;
    }

    //check duplicate EIN
    var ein = $('#oleg_userdirectorybundle_user_credentials_employeeId').val();
    ein = trimWithCheck(ein);
    var user = checkDuplicateIdentifier(ein,'ein');
    var userid = user.id;
    if( userid && (actionFlag == 'new' || userid != origuserid && actionFlag == 'update') ) {

        $('#Credentials').collapse('show');
        $('#identifiers').collapse('show');
        $('#oleg_userdirectorybundle_user_credentials_employeeId').parent().addClass("has-error");

        var alert = "An employee with the provided Employee Identification Number (EIN) "+ein+" already exists: " +
            getUserUrl(userid,user.firstName+" "+user.lastName) +
            "Please correct the new employee's Employe Identification Number (EIN) or edit the existing employee's information.";

        addErrorAlert(alert);

        return false;
    }

    //check duplicate SSN
    var ssn = $('#oleg_userdirectorybundle_user_credentials_ssn').val();
    ssn = trimWithCheck(ssn);
    var user = checkDuplicateIdentifier(ssn,'ssn');
    var userid = user.id;
    if( userid && (actionFlag == 'new' || userid != origuserid && actionFlag == 'update') ) {

        $('#Credentials').collapse('show');
        $('#personalinfo').collapse('show');
        $('#oleg_userdirectorybundle_user_credentials_ssn').parent().addClass("has-error");

        var alert = "An employee with the provided Social Security Number (SSN) "+ssn+" already exists: " +
            getUserUrl(userid,user.firstName+" "+user.lastName) +
            "Please correct the new employee's Social Security Number (SSN) or edit the existing employee's information.";

        addErrorAlert(alert);

        return false;
    }

    //return false; //testing
    $("form:first").submit();
}

function getUserUrl(userid,username) {
    var dataholder = document.querySelector('#form-prototype-data');
    var url = dataholder.dataset.userurllink;
    url = url.replace("user_replacement_id",userid);
    url = url.replace("user_replacement_username",username);
    return url;
}

function addErrorAlert($text) {
    var alert = '<div class="alert alert-danger user-error-alert" role="alert">'+
        $text +
        '</div>';
    $('#user-errors').append(alert);
}

function removeAllErrorAlerts() {
    $('.user-error-alert').remove();
    $('.has-error').removeClass('has-error');
}

function checkDuplicateIdentifier(number,name) {
    var user = new Array();
    var url = getCommonBaseUrl("util/"+name,"employees");
    $.ajax({
        url: url,
        type: 'GET',
        data: {number: number},
        timeout: _ajaxTimeout,
        async: false
    }).success(function(data) {
        if( data.length > 0 ) {
            user = data[0];
        } else {
            user['id'] = null;
        }
    });
    return user;
}
