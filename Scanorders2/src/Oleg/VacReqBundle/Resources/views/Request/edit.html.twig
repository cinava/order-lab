{% extends "OlegVacReqBundle::Default/base.html.twig" %}

{% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}
{% import "OlegUserdirectoryBundle::Default/usermacros.html.twig" as usermacros %}
{% import "OlegUserdirectoryBundle::Tree/treemacros.html.twig" as treemacros %}
{% import "OlegVacReqBundle::Default/vacreqmacros.html.twig" as vacreqmacros %}
{% import "OlegUserdirectoryBundle::Default/userformmacros.html.twig" as userform %}


{% if "show" in cycle %}
    {% set showFlag = true %}
{% else %}
    {% set showFlag = false %}
{% endif %}


{% if review is not defined %}
    {% set review = false %}
{% endif %}

{% block title %}
    Vacation/Business Travel Request
{% endblock %}



{% block content %}

    {% if is_granted('ROLE_VACREQ_ADMIN') %}
        {% if accessreqs is defined and accessreqs and accessreqs > 0 %}
            <div class="alert alert-warning">
                There are <a href="{{ path(vacreq_sitename~'_accessrequest_list') }}" target="_blank">{{ accessreqs }} unprocessed access request(s)</a>
            </div>
        {% endif %}
    {% endif %}

    {% if totalApprovedDaysString is defined and totalApprovedDaysString %}
        <div class="alert alert-info">
            <p>{{ totalApprovedDaysString }}</p>
        </div>
    {% endif %}

    <h4 class="text-info" align="center">
        Vacation/Business Travel Request
    </h4>

    <br>

    {% if (cycle == 'show' or review) and entity.user.id is defined %}
        {{ userform.snapshot_steve(entity.user,vacreq_sitename,cycle) }}
    {% endif %}

    <hr>

    {{ form_start(form,{'attr': {'id': 'vacreq-request-form'}}) }}

        {{ form_errors(form) }}

        {#{{ treemacros.compositeTreeNode(form.institution,cycle,'') }}#}

        {% if form.submitter is defined %}
            {{ formmacros.field(form.submitter) }}
        {% endif %}

        {% if form.user is defined %}
            {{ formmacros.field(form.user) }}
        {% endif %}

        {#{{ formmacros.field(form.phone) }}#}
        {{ usermacros.emailPhoneField(form.phone,cycle,'phone',"") }}

        {#organizationalInstitution => institution#}
        {% if form.institution is defined %}
            {{ formmacros.field(form.institution) }}
        {% endif %}
        {% if form.organizationalInstitution is defined %}
            {{ formmacros.field(form.organizationalInstitution) }}
        {% endif %}


        {#Business#}
        {% set showBusinessStatus = false %}
        {% if entity.requestBusiness and entity.requestBusiness.status is defined %}
            {% set showBusinessStatus = true %}
        {% endif %}
        {% set businessCollapse = '' %}
        {% if (not showFlag and not review) or (entity.requestBusiness and entity.requestBusiness.numberOfDays>0) %}
            {% set businessCollapse = 'in' %}
        {% endif %}
        {#set accordion color#}
        {% set businessPanelColor = 'panel-info' %}
        {% if entity.requestBusiness and entity.requestBusiness.status == 'approved' %}
            {% set businessPanelColor = 'panel-success' %}
        {% endif %}
        {% if entity.requestBusiness and entity.requestBusiness.status == 'rejected' %}
            {% set businessPanelColor = 'panel-danger' %}
        {% endif %}
        {#Business panel#}
        <div class="panel {{ businessPanelColor }}">
            <div class="panel-heading">
                <h4 class="panel-title" align='center'>
                    {#<a data-toggle="collapse" href="#vacreq-Business">#}
                        {#Business Travel#}
                    {#</a>#}
                    {#{{ vacreqmacros.request_radio_choice( form.requestBusiness ) }}#}
                    {% if showBusinessStatus %}
                        <div class="row">
                            <div class="col-xs-6" align="right">
                                <a data-toggle="collapse" href="#vacreq-Business">
                                    Business Travel
                                </a>
                            </div>
                            {#{% if showBusinessStatus %}#}
                                <div class="col-xs-6" align="left" style="color:#333;">
                                    {{ vacreqmacros.request_radio_choice( form.requestBusiness ) }}
                                </div>
                            {#{% endif %}#}
                        </div>
                    {% else %}
                        <a data-toggle="collapse" href="#vacreq-Business">
                            Business Travel
                        </a>
                    {% endif %}
                </h4>
            </div>
            <div id="vacreq-Business" class="panel-collapse collapse {{ businessCollapse }}">
                <div class="panel-body">
                    {{ formmacros.fieldDateLabel(form.requestBusiness.startDate,'allow-future-date') }}
                    {{ formmacros.fieldDateLabel(form.requestBusiness.endDate,'allow-future-date') }}

                    {#{{ formmacros.field(form.requestBusiness.numberOfDays) }}#}
                    {#{{ formmacros.fieldDateLabel(form.requestBusiness.firstDayBackInOffice,'allow-future-date') }}#}
                    {{ vacreqmacros.request_inputWithCalculateBtn(form.requestBusiness.numberOfDays) }}
                    {{ vacreqmacros.request_dateWithCalculateBtn(form.requestBusiness.firstDayBackInOffice) }}

                    {{ formmacros.field(form.requestBusiness.expenses) }}
                    {{ formmacros.checkbox(form.requestBusiness.paidByOutsideOrganization) }}
                    {{ formmacros.field(form.requestBusiness.description) }}
                    {% if form.requestBusiness.approverComment is defined and businessCollapse == 'in'  %}
                        {{ formmacros.field(form.requestBusiness.approverComment) }}
                    {% endif %}
                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-info -->


        {#Vacation#}

        {#set vacationCollapse#}
        {% set showVacationStatus = false %}
        {% if entity.requestBusiness and entity.requestBusiness.status is defined %}
            {% set showVacationStatus = true %}
        {% endif %}
        {% set vacationCollapse = '' %}
        {% if (not showFlag and not review) or (entity.requestVacation and entity.requestVacation.numberOfDays>0) %}
            {% set vacationCollapse = 'in' %}
        {% endif %}
        {#set accordion color#}
        {% set vacationPanelColor = 'panel-info' %}
        {% if entity.requestVacation and entity.requestVacation.status == 'approved' %}
            {% set vacationPanelColor = 'panel-success' %}
        {% endif %}
        {% if entity.requestVacation and entity.requestVacation.status == 'rejected' %}
            {% set vacationPanelColor = 'panel-danger' %}
        {% endif %}
        {#vacation panel#}
        <div class="panel {{ vacationPanelColor }}">
            <div class="panel-heading">
                <h4 class="panel-title">
                    {#<a data-toggle="collapse" href="#vacreq-Vacation">#}
                        {#Vacation Travel#}
                    {#</a>#}
                    {#{{ vacreqmacros.request_radio_choice( form.requestVacation ) }}#}
                    {% if showVacationStatus %}
                        <div class="row">
                            <div class="col-xs-6" align="right">
                                <a data-toggle="collapse" href="#vacreq-Vacation">
                                    Vacation Travel
                                </a>
                            </div>
                            {#{% if showVacationStatus %}#}
                                <div class="col-xs-6" align="left" style="color:#333;">
                                    {{ vacreqmacros.request_radio_choice( form.requestVacation ) }}
                                </div>
                            {#{% endif %}#}
                        </div>
                    {% else %}
                        <a data-toggle="collapse" href="#vacreq-Vacation">
                            Vacation Travel
                        </a>
                    {% endif %}
                </h4>
            </div>
            <div id="vacreq-Vacation" class="panel-collapse collapse {{ vacationCollapse }}">
                <div class="panel-body">
                    {{ formmacros.fieldDateLabel(form.requestVacation.startDate,'allow-future-date') }}
                    {{ formmacros.fieldDateLabel(form.requestVacation.endDate,'allow-future-date') }}

                    {#{{ formmacros.field(form.requestVacation.numberOfDays) }}#}
                    {{ vacreqmacros.request_inputWithCalculateBtn(form.requestVacation.numberOfDays) }}

                    {#{{ formmacros.fieldDateLabel(form.requestVacation.firstDayBackInOffice,'allow-future-date') }}#}
                    {{ vacreqmacros.request_dateWithCalculateBtn(form.requestVacation.firstDayBackInOffice) }}

                    {% if form.requestVacation.approverComment is defined and vacationCollapse == 'in' %}
                        {{ formmacros.field(form.requestVacation.approverComment) }}
                    {% endif %}
                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-info -->

        {#{{ formmacros.fieldDateLabel(form.credentials.dob,'allow-future-date') }}#}


        {#Emergency#}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#Emergency">
                        Emergency Contact Info (optional)
                    </a>
                </h4>
            </div>
            <div id="Emergency" class="panel-collapse collapse in">
                <div class="panel-body">
                    {#{{ formmacros.field(form.availabilities) }}#}
                    {#{{ formmacros.field(form.emergencyComment) }}#}
                    {#{{ formmacros.field(form.emergencyCellPhone) }}#}
                    {#{{ formmacros.field(form.emergencyOther) }}#}

                    {{ formmacros.field(form.availableViaEmail) }}
                    {{ formmacros.field(form.availableEmail) }}

                    {{ formmacros.field(form.availableViaCellPhone) }}
                    {{ formmacros.field(form.availableCellPhone) }}

                    {{ formmacros.field(form.availableViaOther) }}
                    {{ formmacros.field(form.availableOther) }}

                    {{ formmacros.field(form.availableNone) }}

                </div> <!-- panel-body -->
            </div> <!-- panel-collapse -->
        </div> <!-- panel panel-info -->


        {% if form.status is defined %}
            {{ formmacros.field(form.status) }}
        {% endif %}

    {{ form_end(form,{'render_rest': false}) }}

    <br>

    <div id="error-box" class="alert alert-danger" style="display: none"></div>

    <br>

    {% if cycle == "new" %}
        <p>
            <button class="btn btn-warning" name="btnCreate" type="button" onclick="validateVacReqForm(this)">Submit</button>
        </p>
    {% endif %}

    {% if cycle == "edit" %}
        <p>
            <button class="btn btn-warning" name="btnUpdate" type="button" onclick="validateVacReqForm(this)">Update</button>
            <a class="btn btn-primary" href="{{ path(vacreq_sitename~'_show',{'id':entity.id}) }}">Cancel</a>
        </p>
    {% endif %}

    {% if cycle == "show" %}
        <p>
            <a class="btn btn_margin_top btn-primary" href="{{ path(vacreq_sitename~'_edit',{'id':entity.id}) }}">Edit</a>
        </p>
    {% endif %}

{% endblock %}


{% block additionaljs %}

    <script language="Javascript">

        $(document).ready(function() {

            vacreqDateListener();

            vacreqAvailabilityListener();

            vacreqNumberOfDaysListener();

        });

        function vacreqAvailabilityListener() {
            $('.vacreq-availableNone').on("click", function(e) {
                var holder = $(this).closest('.panel-body');

                if ($(this).is(':checked')) {
                    holder.find('.vacreq-availableViaEmail').prop('checked', false);
                    holder.find('.vacreq-availableEmail').val('');

                    holder.find('.vacreq-availableViaCellPhone').prop('checked', false);
                    holder.find('.vacreq-availableCellPhone').val('');

                    holder.find('.vacreq-availableViaOther').prop('checked', false);
                    holder.find('.vacreq-availableOther').val('');
                }

            });

            $('.vacreq-availableViaEmail, .vacreq-availableViaCellPhone, .vacreq-availableViaOther').on("click", function(e) {
                var holder = $(this).closest('.panel-body');

                if ($(this).is(':checked')) {
                    holder.find('.vacreq-availableNone').prop('checked', false);
                }

            });
        }

        function vacreqAvailabilityListener_OLD() {
            $('.vacreq-availabilities').on("change", function(e) {
                var holder = $(this).closest('.panel-body');
                var availabilities = holder.find('.vacreq-availabilities').first().select2('data');
                //console.log(availabilities);

                //this returns all the selected item
                var items= $(this).val();
                //console.log('items='+items);

                $.each( availabilities, function( key, value ) {
                    //console.log( key + ": " + value );
                    //console.log( value );
                    var item = value.text;
                    //console.log('item='+item);
                    if( item == "Not Accessible" ) {
                        //clear others
                        holder.find('.vacreq-availabilities').first().select2('val',value.id);
                    }

                });

            });
        }

        function vacreqNumberOfDaysListener() {
            $('.vacreq-numberOfDays, .vacreq-expenses, .vacreq-description').on("input", function(e) {
                $(this).removeClass('alert-danger');
            });

            $('.vacreq-firstDayBackInOffice').datepicker().on("changeDate", function(e) {
                $(this).removeClass('alert-danger');
            });
        }

        function vacreqDateListener() {

            $('.vacreq-startDate,.vacreq-endDate').datepicker().on("changeDate", function(e) {
                //vacreqUpdateDaysAndFirstday(this);

                var holder = $(this).closest('.panel-body');

                var startDate = holder.find('.vacreq-startDate').first().datepicker('getDate');
                var endDate = holder.find('.vacreq-endDate').first().datepicker('getDate');
                //console.log('startDate=('+startDate+')' + ', endDate=('+endDate+')');


                //get working days difference
                if( startDate && endDate ) {

                    if( startDate > endDate ) {
                        e.stopPropagation();
                        e.preventDefault();
                        alert("The requested End Date cannot precede the Start Date.");
                        //setVacReqDates(holder,null,null);
                        $(this).datepicker('setDate', null);
                        return;
                    }

                    //var oneDay = 24*60*60*1000; // hours*minutes*seconds*milliseconds
                    //var diffDays = 1 + Math.round(Math.abs((startDate.getTime() - endDate.getTime())/(oneDay)));
                    var diffWorkingDays = calculateWorkingDays(startDate,endDate);
                    //console.log('diffWorkingDays='+diffWorkingDays);

                    if( diffWorkingDays > 0 ) {
                        //numberOfDays
                        //holder.find('.vacreq-numberOfDays').first().val(diffWorkingDays);

                        //firstDayBackInOffice
                        var nextWorkingDay = getNextWorkingDay(endDate);
                        //console.log('nextWorkingDay='+nextWorkingDay);
                        //holder.find('.vacreq-firstDayBackInOffice').first().datepicker('setDate', nextWorkingDay);

                        setVacReqDates(holder,diffWorkingDays,nextWorkingDay)
                    } else {
                        //setVacReqDates(holder,null,null);
                    }

                }//if

            });

        }

        function setVacReqDates(holder,diffWorkingDays,nextWorkingDay) {

            var numberOfDaysField = holder.find('.vacreq-numberOfDays').first();
            if( !numberOfDaysField.val() ) {
                numberOfDaysField.val(diffWorkingDays);
                numberOfDaysField.removeClass('alert-danger');
            }

            var firstDayBackInOffice = holder.find('.vacreq-firstDayBackInOffice').first();
            if( !firstDayBackInOffice.datepicker('getDate') ) {
                firstDayBackInOffice.datepicker('setDate', nextWorkingDay);
            }
        }

        //onclick action button
        function setVacReqNumberOfDays(btn,event) {
            var holder = $(btn).closest('.panel-body');
            var startDate = holder.find('.vacreq-startDate').first().datepicker('getDate');
            var endDate = holder.find('.vacreq-endDate').first().datepicker('getDate');
            //console.log('startDate=('+startDate+')' + ', endDate=('+endDate+')');

            event.stopPropagation();
            event.preventDefault();

            holder.find('.vacreq-numberOfDays').first().removeClass('alert-danger');

            var diffWorkingDays = null;

            if( startDate && endDate ) {
                if( startDate > endDate ) {
                    alert("The requested Last Day Away cannot precede the First Day Away.");
                    holder.find('.vacreq-numberOfDays').first().val(null);
                    return null;
                }

                diffWorkingDays = calculateWorkingDays(startDate,endDate);

                if( diffWorkingDays > 0 ) {
                    //numberOfDays
                    holder.find('.vacreq-numberOfDays').first().val(diffWorkingDays);
                } else {
                    holder.find('.vacreq-numberOfDays').first().val(null);
                }
            }

            return diffWorkingDays;
        }

        //onlcick
        function setVacReqFirstDayBack(btn,event) {
            var holder = $(btn).closest('.panel-body');
            var startDate = holder.find('.vacreq-startDate').first().datepicker('getDate');
            var endDate = holder.find('.vacreq-endDate').first().datepicker('getDate');
            //console.log('startDate=('+startDate+')' + ', endDate=('+endDate+')');
            //holder.find('.vacreq-firstDayBackInOffice').first().datepicker('hide');

            event.stopPropagation();
            event.preventDefault();

            var nextWorkingDay = null;

            holder.find('.vacreq-firstDayBackInOffice').first().removeClass('alert-danger');

            //get working days difference
            if( startDate && endDate ) {

                if( startDate > endDate ) {
                    alert("The requested Last Day Away cannot precede the First Day Away.");
                    holder.find('.vacreq-firstDayBackInOffice').first().datepicker('setDate', null);
                    return;
                }

                //var oneDay = 24*60*60*1000; // hours*minutes*seconds*milliseconds
                //var diffDays = 1 + Math.round(Math.abs((startDate.getTime() - endDate.getTime())/(oneDay)));
                var diffWorkingDays = calculateWorkingDays(startDate,endDate);
                //console.log('diffWorkingDays='+diffWorkingDays);

                if( diffWorkingDays > 0 ) {
                    //firstDayBackInOffice
                    nextWorkingDay = getNextWorkingDay(endDate);
                    //console.log('nextWorkingDay='+nextWorkingDay);
                    holder.find('.vacreq-firstDayBackInOffice').first().datepicker('setDate', nextWorkingDay);
                } else {
                    holder.find('.vacreq-firstDayBackInOffice').first().datepicker('setDate', null);
                }

            }//if

            //holder.find('.vacreq-firstDayBackInOffice').first().datepicker('hide');

            return nextWorkingDay;
        }

        // Count days from d0 to d1 inclusive, excluding Fridays and Saturdays
        function calculateWorkingDays( startDate, endDate )  {
            var days = 0;
            for( var i = startDate; i <= endDate; i.setDate(i.getDate() + 1) ) {
                if( i.getDay() != 6 && i.getDay() != 0 ) {
                    days = days + 1;
                }
            }
            return days;
        }



        function getNextWorkingDay( endDate )  {
            var finishDate = new Date();
            finishDate.setDate(endDate.getDate()+7);
            //console.log('finishDate='+finishDate+", day="+finishDate.getDay());

            var nextWorkingDay = new Date();
            nextWorkingDay.setDate(endDate.getDate()+1);

            for( nextWorkingDay; nextWorkingDay <= finishDate; nextWorkingDay.setDate(nextWorkingDay.getDate() + 1) ) {
                //console.log('nextWorkingDay='+nextWorkingDay+", day="+nextWorkingDay.getDay());
                if( nextWorkingDay.getDay() != 6 && nextWorkingDay.getDay() != 0 ) {
                    return nextWorkingDay;
                }
            }
            return null;
        }

        function validateVacReqForm(btn) {

            var lbtn = Ladda.create(btn);
            lbtn.start();

            $('#error-box').hide();

            //remove alert-danger from input fields
            $('input').removeClass('alert-danger');

            var error = null;

            var userData = $('.vacreq-user').first().select2('data');
            if( !error && !userData ) {
                error = "Please choose a requester";
            }

            var userInstitution = $('.vacreq-institution').first().select2('data');
            if( !error && !userInstitution ) {
                error = "Please choose an organizational group";
                //$('.vacreq-institution').first().addClass('alert-danger');
            }

            var approverData = $('.vacreq-approver').first().select2('data');
            if( !error && !approverData ) {
                error = "Please choose an approver";
            }

            var businessRequest = $('#vacreq-Business');
            var vacationRequest = $('#vacreq-Vacation');

            var startDateBusiness = businessRequest.find('.vacreq-startDate').first().val();
            var endDateBusiness = businessRequest.find('.vacreq-endDate').first().val();
            //console.log('startDateBusiness=('+startDateBusiness+')' + 'endDateBusiness=('+endDateBusiness+')');

            var startDateVacation = vacationRequest.find('.vacreq-startDate').first().val();
            var endDateVacation = vacationRequest.find('.vacreq-endDate').first().val();
            //console.log('startDateVacation=('+startDateVacation+')' + 'endDateVacation=('+endDateVacation+')');

            if( !error && !startDateBusiness && !startDateVacation ) {
                error = "Please fill in the First Day Away";
            }

            //console.log('endDate=('+endDate+')');
            if( !error && !endDateBusiness && !endDateVacation ) {
                error = "Please fill in the Last Day Away";
            }

            //Business
            if( !error && startDateBusiness && endDateBusiness ) {

                var numberOfDays = businessRequest.find('.vacreq-numberOfDays').first().val();
                if( !error && !numberOfDays ) {
                    error = "Please enter the number of work days off-site";
                    businessRequest.find('.vacreq-numberOfDays').addClass('alert-danger');
                }

                var firstDayBackInOffice = businessRequest.find('.vacreq-firstDayBackInOffice').first().val();
                if( !error && !firstDayBackInOffice ) {
                    error = "Please fill in the first day back in office";
                    businessRequest.find('.vacreq-firstDayBackInOffice').addClass('alert-danger');
                }

                var expenses = businessRequest.find('.vacreq-expenses').first().val();
                if( !error && !expenses ) {
                    error = "Please fill in the estimated expenses";
                    businessRequest.find('.vacreq-expenses').addClass('alert-danger');
                }

                var description = businessRequest.find('.vacreq-description').first().val();
                if( !error && !description ) {
                    error = "Please fill in the description";
                    businessRequest.find('.vacreq-description').addClass('alert-danger');
                }

            }

            //Vacation
            if( !error && startDateVacation && endDateVacation ) {

                var numberOfDays = vacationRequest.find('.vacreq-numberOfDays').first().val();
                if( !error && !numberOfDays ) {
                    error = "Please enter the number of work days off-site";
                    vacationRequest.find('.vacreq-numberOfDays').addClass('alert-danger');
                }

                var firstDayBackInOffice = vacationRequest.find('.vacreq-firstDayBackInOffice').first().val();
                if( !error && !firstDayBackInOffice ) {
                    error = "Please fill in the first day back in office";
                    vacationRequest.find('.vacreq-firstDayBackInOffice').addClass('alert-danger');
                }

            }

            //console.log('error='+error);

            if( error ) {
                $('#error-box').html(error);
                $('#error-box').show();
                lbtn.stop();
                return false;
            }

            $('#vacreq-request-form').submit();
        }


    </script>
{% endblock %}


{#Snapshot css#}
{% block additionalcss %}
    {% stylesheets
        'bundles/oleguserdirectory/form/css/steve-snapshot.css' filter='cssrewrite'
    %}
    <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}
