{% extends "OlegTranslationalResearchBundle::Default/base.html.twig" %}

{% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}

{% block title %}
    {{ title }}
{% endblock %}


{% block content %}

    <h4 class="text-info" align="center">
        {{ title }}
    </h4>

    <p>
        {{ requestTotalFeeHtml|raw }}
    </p>

    <div class="well form-search">
        {{ form_start(filterform) }}

        {#"Category", "Project Specialty" [AP/CP or Hematopathology], "Project", "Work Progress Status", "Billing Progress Status", and "Submitter"#}
        <div class="row">
            <div class="col-xs-4">
                {{ form_widget(filterform.category,{'attr': {'placeholder': 'Category'}}) }}
            </div>
            <div class="col-xs-4">
                {{ form_widget(filterform.projectSpecialty, {'attr': {'placeholder': 'Project Specialty'}}) }}
            </div>
            <div class="col-xs-4">
                {{ form_widget(filterform.project) }}
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-xs-4">
                {{ form_widget(filterform.progressState, {'attr': {'placeholder': 'Work Progress Status'}}) }}
            </div>
            <div class="col-xs-4">
                {{ form_widget(filterform.billingState, {'attr': {'placeholder': 'Billing Progress Status'}}) }}
            </div>
            <div class="col-xs-4">
                {{ form_widget(filterform.submitter, {'attr': {'placeholder': 'Submitter'}}) }}
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-xs-12">
                <button id="Search_button" type="submit" class="btn btn-default">Filter</button>
            </div>
        </div>

        {#advanced search#}
        {% if advancedFilter %}
            {% set advacedCollapse = 'in' %}
        {% else %}
            {% set advacedCollapse = '' %}
        {% endif %}
        <br>
        <div class="row">
            <a data-toggle="collapse" href="#transres-AdvancedSearch">Advanced Search</a>
        </div>
        <div id="transres-AdvancedSearch" class="panel-collapse collapse {{ advacedCollapse }}">
            <div class="panel-body">

                <div class="row">
                    <div class="col-xs-4">
                        {{ form_widget(filterform.principalInvestigators,{'attr': {'placeholder': 'Principal Investigators'}}) }}
                    </div>
                    <div class="col-xs-4">
                        {{ formmacros.fielddate(filterform.startDate,'regular-datepicker') }}
                    </div>
                    <div class="col-xs-4">
                        {{ formmacros.fielddate(filterform.endDate,'regular-datepicker') }}
                    </div>
                </div>

                <br>

                <div class="row">
                    <div class="col-xs-4">
                        {{ form_widget(filterform.billingContact, {'attr': {'placeholder': 'Billing Contact'}}) }}
                    </div>
                    <div class="col-xs-4">
                        {{ form_widget(filterform.accountNumber, {'attr': {'placeholder': 'WCM Account Number'}}) }}
                    </div>
                    <div class="col-xs-4">
                        {{ form_widget(filterform.comment,{'attr': {'placeholder': 'Comment Search'}}) }}
                    </div>
                </div>

            </div> <!-- panel-body -->
        </div> <!-- panel-collapse -->


        {#<p>#}
        {#<div class="row">#}
            {#<div class="col-xs-4">#}
                {#{% if filterform.submitter is defined %}#}
                    {#{{ form_widget(filterform.submitter, {'attr': {'placeholder': 'Submitter'}}) }}#}
                {#{% endif %}#}
            {#</div>#}
            {#<div class="col-xs-4">#}
                {#{{ form_widget(filterform.progressState, {'attr': {'placeholder': 'Work Progress Status'}}) }}#}
            {#</div>#}
            {#<div class="col-xs-4">#}
                {#{{ form_widget(filterform.billingState, {'attr': {'placeholder': 'Billing Progress Status'}}) }}#}
            {#</div>#}
        {#</div>#}
        {#</p>#}
        {#<p>#}
        {#<div class="row">#}
            {#<div class="col-xs-4">#}
                {#{{ form_widget(filterform.category,{'attr': {'placeholder': 'Category'}}) }}#}
            {#</div>#}
            {#<div class="col-xs-4">#}
                {#{{ form_widget(filterform.comment,{'attr': {'placeholder': 'Comment Search'}}) }}#}
            {#</div>#}
        {#</div>#}
        {#</p>#}
        {#<div class="row">#}
            {#<div class="col-xs-12">#}
                {#<button type="submit" id="filter-btn" class="btn btn-sm btn-default">Filter</button>#}
            {#</div>#}
        {#</div>#}
        {{ form_end(filterform) }}
    </div>
    <br>

    {% set isRequestCanBeCreated = transres_request_util.isRequestCanBeCreated(project) %}
    {% if isRequestCanBeCreated == 1 %}
        <br>
        <p>
            <a class="btn btn-primary" href="{{ path(translationalresearch_sitename~'_request_new', {'id':project.id}) }}"
            >Create a new Request</a>
        </p>
        <br>
    {% endif %}

    {#<table class="table table-hover table-condensed text-left table-bordered">#}
    <table class="records_list table table-condensed text-left my-table-class">
        <thead>
            <tr>
                {#<th>Id</th>#}
                <th>{{ knp_pagination_sortable(transresRequests, 'ID', 'transresRequest.oid') }}</th>
                <th>{{ knp_pagination_sortable(transresRequests, 'Submitter', 'submitterInfos.displayName') }}</th>
                <th>{{ knp_pagination_sortable(transresRequests, 'Creation Date', 'transresRequest.createDate') }}</th>
                <th>{{ knp_pagination_sortable(transresRequests, 'Work Progress Status', 'transresRequest.progressState') }}</th>
                <th>{{ knp_pagination_sortable(transresRequests, 'Billing Progress Status', 'transresRequest.billingState') }}</th>
                {#<th>{{ knp_pagination_sortable(projects, 'Expiration Date', 'project.expirationDate') }}</th>#}
                <th>Products/Services</th>
                <th>Fee</th>
                <th># Invoices</th>
                <th>Actions</th>
            </tr>
        </thead>

        {% set count = 0 %}
        {% for transresRequest in transresRequests %}

            {% if count is odd %}
                {% set trclassname = "table-row-separator-gray" %}
            {% else %}
                {% set trclassname = "table-row-separator-white" %}
            {% endif %}
            {% set count = count + 1 %}

            {#add if state has "_rejected"?#}
            {#{% if project.state == 'not_approved' or project.state == 'closed' %}#}
                {#{% set trclassname = "order-reject-status" %}#}
            {#{% endif %}#}

            <tbody data-link="row" class="rowlink table-tbody-hover" {{ trclassname }}>
            <tr style="border-bottom: 1px solid #C6C6C6;">
                <td>
                    <a href="{{ path(translationalresearch_sitename~'_request_show', { 'id': transresRequest.id }) }}" target="_blank">{{ transresRequest.oid }}</a>
                </td>

                <td class="rowlink-skip">
                    {#{{ principalInvestigator }}<br>#}
                    {% set personurl = path(translationalresearch_sitename~'_showuser',{'id':transresRequest.submitter.id}) %}
                    {% set personlink = '<a href="'~personurl~'" target="_blank">'~transresRequest.submitter.getUsernameOptimal()~'</a>'  %}
                    {{ personlink|raw }}<br>
                </td>

                <td>
                    {% if transresRequest.createDate %}
                        {{ transresRequest.createDate|date('Y-m-d H:i:s') }}
                    {% endif %}
                </td>

                <td>
                    {{ transres_request_util.getProgressStateLabelByName(transresRequest.progressState) }}
                </td>

                <td>
                    {{ transres_request_util.getBillingStateLabelByName(transresRequest.billingState) }}
                </td>

                <td>
                    {% for product in transresRequest.products %}
                        {% if product.category %}
                            {{ product.category.getShortInfo() }}<br>
                        {% endif %}
                    {% endfor %}
                </td>

                <td>
                    {#{{ principalInvestigator }}<br>#}
                    {% set fee = transres_request_util.getTransResRequestFeeHtml(transresRequest) %}
                    {% if fee %}
                        ${{ fee|raw }}
                    {% endif %}
                </td>

                <td>
                    {% set invoicesCount = transresRequest.invoices|length %}
                    {% if invoicesCount > 0 %}
                        {{ invoicesCount }}
                    {% endif %}
                </td>

                <td class="rowlink-skip">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                            Action <span class="caret"></span>
                        </button>

                        <ul class="dropdown-menu dropdown-menu-right">

                            <li>
                                <a href="{{ path(translationalresearch_sitename~'_request_show', { 'id': transresRequest.id }) }}" target="_blank">Show Request</a>
                            </li>


                            {% if is_granted('ROLE_TRANSRES_ADMIN') or transresRequest.submitter.id == app.user.id %}
                                <li>
                                    <a href="{{ path(translationalresearch_sitename~'_request_edit', { 'id': transresRequest.id }) }}" target="_blank">Edit Request</a>
                                </li>
                            {% endif %}

                            {% if transres_request_util.isRequestProgressReviewable(transresRequest) %}
                            {% if transres_util.isAdminOrPrimaryReviewer() or transres_request_util.isRequestProgressReviewer(transresRequest) %}
                                <li>
                                    <a href="{{ path(translationalresearch_sitename~'_request_review_progress_state', { 'id': transresRequest.id }) }} " target="_blank">Change Work Progress Status</a>
                                </li>
                            {% endif %}
                            {% endif %}

                            {% if transres_request_util.isRequestBillingReviewable(transresRequest) %}
                            {% if transres_util.isAdminOrPrimaryReviewer() or transres_request_util.isRequestBillingReviewer(transresRequest) %}
                                <li>
                                    <a href="{{ path(translationalresearch_sitename~'_request_review_billing_state', { 'id': transresRequest.id }) }} " target="_blank">Change Billing Progress Status</a>
                                </li>
                            {% endif %}
                            {% endif %}


                            <li class="divider"></li>
                            <li>
                                <a href="{{ path(translationalresearch_sitename~'_invoice_index', { 'id': transresRequest.id }) }} " target="_blank">Show All Invoice</a>
                            </li>
                            <li>
                                <a href="{{ path(translationalresearch_sitename~'_invoice_new', { 'id': transresRequest.id }) }} " target="_blank">Create New Invoices</a>
                            </li>

                        </ul>

                    </div>
                </td>
            </tr>
            {#<tr class="table-no-border">#}
                {#<td style="display: none">#}
                    {#<a href="{{ path(translationalresearch_sitename~'_request_show', { 'id': transresRequest.id }) }}" target="_blank">Show Request</a>#}
                {#</td>#}
                {#{{ user_formnode_utility.getFormNodeHolderShortInfo(transresRequest,transresRequest.messageCategory,1,trclassname)|raw }}#}
            {#</tr>#}
        {% endfor %}
        </tbody>
    </table>

    {# display navigation #}
    <div class="navigation">
        {{ knp_pagination_render(transresRequests) }}
    </div>

    {#{{ render(controller('OlegTranslationalResearchBundle:Project:threadComments', { 'id': "3-9-committee_review" })) }}#}
    {#{% include 'FOSCommentBundle:Thread:async.html.twig' with {'id': "3-9-committee_review"} %}#}

    {% if isRequestCanBeCreated == 1 %}
        <br>
        <p>
            <a class="btn btn-primary" href="{{ path(translationalresearch_sitename~'_request_new', {'id':project.id}) }}"
            >Create a new Request</a>
        </p>
        <br>
    {% endif %}

{% endblock %}
