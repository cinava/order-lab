{% extends "OlegTranslationalResearchBundle::Default/base.html.twig" %}

{% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}
{% import "OlegTranslationalResearchBundle::Default/transresRequestMacros.html.twig" as transresRequestMacros %}
{% import "OlegTranslationalResearchBundle::Default/transres.html.twig" as transres %}


{% block title %}
    {{ title }}
{% endblock %}


{% block content %}

    {#<input type="hidden" id="formnodetrigger" value="{{ formnodetrigger }}" />#}
    {#<input type="hidden" id="formnodeTopHolderId" value="{{ formnodeTopHolderId }}" />#}
    <input type="hidden" id="formcycle" value="{{ cycle }}" />

    <h4 class="text-info" align="center">
        {{ title }}
    </h4>
    <br>

{% if routeName == "translationalresearch_new_standalone_request" and form.project is not defined %}
    <p>There are no approved projects are available at this time.</p>
{% else %}

    {% set sitename = translationalresearch_sitename %}

    {{ form_start(form) }}

        <div id="form-prototype-data"
             data-userurllink = "{{ usermacros.userUrlLink()|e }}"
             data-uploadurl = "{{ oneup_uploader_endpoint('transres_gallery') }}"
             data-userid = "{{ app.user.id }}"

             data-prototype-transres-products = "{{ transresRequestMacros.productForm(form.products,cycle,'transres-products','prototype',sitename,1)|e }}"
        ></div>

        {% if form.project is defined %}
            {{ formmacros.field(form.project) }}
        {% endif %}

        {#{{ transres.getProjectReviewPrototypeFormData(null,cycle,sitename) }}#}

        {{ transresRequestMacros.transresRequestBody(form,transresRequest,cycle,sitename) }}

        {% if cycle != "new" %}
            {{ transresRequestMacros.transresRequestHandsontable(form,transresRequest,cycle) }}
        {% endif %}

        {#<p>#}
            {#Table Triggered:<br>#}
            {#<div id="test-barcode-image"></div>#}
        {#</p>#}

        {#<p>#}
            {#Datamatrix Triggered:<br>#}
            {#<div id="test-datamatrix"></div>#}
        {#</p>#}

        {{ transresRequestMacros.transresRequestDetails(form,transresRequest,cycle,sitename) }}

        {{ transresRequestMacros.transresRequestComment(form,transresRequest,cycle) }}

        {% if cycle != "new" and is_granted('ROLE_TRANSRES_ADMIN') %}
            {{ transresRequestMacros.transresRequestInfo(form,transresRequest,cycle) }}
        {% endif %}

        {% if form.updateDate is defined or form.updateUser is defined  %}
            <div class="well well-sm">
                {% if form.updateDate is defined %}
                    {{ formmacros.field(form.updateDate) }}
                {% endif %}
                {% if form.updateUser is defined %}
                    {{ formmacros.field(form.updateUser) }}
                {% endif %}
            </div>
        {% endif %}


        {% if form.saveAsUpdate is defined %}
            {{ form_widget(form.saveAsUpdate) }}
        {% endif %}
        {% if form.saveAsDraft is defined %}
            {{ form_widget(form.saveAsDraft) }}
        {% endif %}
        {% if form.saveAsComplete is defined %}
            {{ form_widget(form.saveAsComplete) }}
        {% endif %}

    {{ form_end(form) }}


    {% if cycle == "show" %}
        <br>
        <p>
            <a class="btn btn-default" href="{{ path(translationalresearch_sitename~'_request_edit', { 'id': transresRequest.id }) }}">Edit Request</a>
        </p>
    {% endif %}


    {% if project and project.id %}
        <br>
        {{ transres.projectObjFullInfo(project,cycle) }}
        <p>
            <a href="{{ path(translationalresearch_sitename~'_request_index',{'id':project.id}) }}">Back to the request list</a>
        </p>
    {% endif %}

{% endif %} {#routeName and project#}

{% endblock %}



{% block additionalcss %}

    {% stylesheets '@FOSCommentBundle/Resources/public/css/comments.css' %}
    <link rel="stylesheet" href="{{ asset_url }}" type="text/css" />
    {% endstylesheets %}

    {% stylesheets
    'bundles/olegtranslationalresearch/form/css/comments.css' filter='cssrewrite'
    %}
    <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}

    {% stylesheets
    'bundles/olegorderform/handsontable/jquery.handsontable.full.css' filter='cssrewrite'
    'bundles/olegorderform/form/css/handsontable.css' filter='cssrewrite'
    %}
    <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}

{% endblock %}


{% block additionaljs %}

    {% javascripts
    '@OlegOrderformBundle/Resources/public/handsontable/jquery.handsontable.full.js'
    '@OlegTranslationalResearchBundle/Resources/public/form/js/handsontable.js'
    '@OlegUserdirectoryBundle/Resources/public/bwip-js/bwipjs.js'
    '@OlegUserdirectoryBundle/Resources/public/bwip-js/bwipp-min.js'
    '@OlegUserdirectoryBundle/Resources/public/bwip-js/freetype.js'
    %}
    <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script type="text/javascript">

        var _handsometableDataArr = [];

        $(document).ready(function() {

            //if( $('#oleg_translationalresearchbundle_request_project') ) {
                //var projectId = $('#oleg_translationalresearchbundle_request_project').val();
                transresPrepopulateFundedAccountNumber( $('#oleg_translationalresearchbundle_request_project') );

                //update tarnsresrequest-fundedAccountNumber by tarnsresrequest-project
                $('#oleg_translationalresearchbundle_request_project').on("change", function(event) {
                    //console.log("project changed: change");
                    //var projectId = $(this).val();
                    //transresPrepopulateFundedAccountNumber(projectId);
                    transresPrepopulateFundedAccountNumber( $(this) );
                });
            //}

            var tableFormCycle = '{{ cycle }}';
            //console.log('tableFormCycle='+tableFormCycle);

            if( tableFormCycle != "new" ) {
                var _handsometableDataArr = {{ handsometableData|json_encode|raw }};
                //console.log('init _handsometableDataArr:');
                //console.log(_handsometableDataArr);

                handsonTableInit(_handsometableDataArr, tableFormCycle);
            }

//            $('.table-barcode').on("change", function(event) {
//                transresTableBarcodeGeneration( $(this) );
//            });

        });

        function transresPrepopulateFundedAccountNumber( projectField ) {
            var projectId = null;    //$('#oleg_translationalresearchbundle_request_project');
            if( projectField.length ) {
                projectId = projectField.val();
            } else {
                return;
            }

            console.log("projectId="+projectId);
            if( projectId ) {
                //console.log("get project account number");

                var url = Routing.generate('translationalresearch_get_project_ajax');
                url = url + "/" + projectId;

                $.ajax({
                    url: url,
                    timeout: _ajaxTimeout,
                    type: "GET",
                    //data: {id: projectId },
                    dataType: 'json',
                    async: asyncflag
                }).success(function(response) {
                    //console.log(response);
                    $("#oleg_translationalresearchbundle_request_fundedAccountNumber").val(response.fundedAccountNumber);
                }).done(function() {
                    //
                }).error(function(jqXHR, textStatus, errorThrown) {
                    //console.log('Error : ' + errorThrown);
                    $("#oleg_translationalresearchbundle_request_fundedAccountNumber").val(errorThrown);
                });

            } else {
                $("#oleg_translationalresearchbundle_request_fundedAccountNumber").val(null);
            }
        }



//        function transresTableBarcodeGeneration( barcodeField ) {
//            console.log("generate barcode");
//            //generate barcode
//            var barcode = null;
//            var image = '<img src="https://www.imgonline.com.ua/examples/random-pixels.jpg" alt="Smiley face" height="42" width="42">';
//
//            //put barcode image to '.table-barcode-image'
//            barcodeField.closest(".table-barcode-image").html(image);
//
//            let canvas = document.createElement('canvas');
//            bwipjs(canvas, options, function(err, cvs) {
//                console.log("bwipjs function");
//                if (err) {
//                    // handle the error
//                    console.log(err);
//                } else {
//                    console.log("set barcode image");
//                    // Don't need the second param since we have the canvas in scope...
//                    document.getElementById('test-barcode-image').src = canvas.toDataURL('image/png');
//                }
//            });
//        }


    </script>


{% endblock %}
