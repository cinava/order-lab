{% extends "OlegTranslationalResearchBundle::Default/base.html.twig" %}

{% import "OlegTranslationalResearchBundle::Default/transresRequestMacros.html.twig" as transresRequestMacros %}

{% block title %}
    {{ metaTitle }}
{% endblock %}

{% block content %}
    <h4 class="text-info" align="center">
        {{ title|raw }}
    </h4>
    <br>

    {% if transresRequest %}
        <p>
            <a href="{{ path('translationalresearch_invoice_new', {'id': transresRequest.id}) }}">Create a new invoice</a>
        </p>
        <br>
    {% endif %}

    {{ transresRequestMacros.transresInvoiceFilter(filterform,advancedFilter) }}
    <br>

    <table class="records_list table table-condensed text-left">
        <thead>
            <tr>
                <th>{{ knp_pagination_sortable(invoices, 'Invoice Number', 'invoice.oid') }}</th>
                <th>{{ knp_pagination_sortable(invoices, 'Salesperson', 'salesperson.displayName') }}</th>
                <th>{{ knp_pagination_sortable(invoices, 'Version', 'invoice.version') }}</th>
                <th>{{ knp_pagination_sortable(invoices, 'Create Date', 'invoice.createDate') }}</th>
                <th>{{ knp_pagination_sortable(invoices, 'Update Date', 'invoice.updateDate') }}</th>
                <th>{{ knp_pagination_sortable(invoices, 'Due Date', 'invoice.dueDate') }}</th>
                <th>{{ knp_pagination_sortable(invoices, 'Status', 'invoice.status') }}</th>
                <th>{{ knp_pagination_sortable(invoices, 'Bill To', 'invoice.invoiceTo') }}</th>
                <th>{{ knp_pagination_sortable(invoices, 'Total', 'invoice.total') }}</th>
                <th>#PDFs</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody data-link="row">
        {% for invoice in invoices %}
            <tr>
                <td>
                    <a href="{{ path('translationalresearch_invoice_show', {'oid': invoice.oid }) }}">{{ invoice.oid }}</a>
                </td>
                <td>{{ invoice.salesperson }}</td>
                <td>
                    {{ invoice.version }}
                    {% if invoice.latestVersion %}
                        (Latest)
                    {% endif %}
                </td>
                <td>{% if invoice.createDate %}{{ invoice.createDate|date('Y-m-d H:i:s') }}{% endif %}</td>
                <td>{% if invoice.updateDate %}{{ invoice.updateDate|date('Y-m-d H:i:s') }}{% endif %}</td>
                <td>{% if invoice.dueDate %}{{ invoice.dueDate|date('Y-m-d H:i:s') }}{% endif %}</td>
                <td>{{ invoice.status }}</td>
                <td>
                    {#{{ invoice.invoiceTo }}#}
                    {{ invoice.invoiceTo|length > 25 ? invoice.invoiceTo|slice(0, 25) ~ '...' : invoice.invoiceTo  }}
                </td>
                <td>
                    {% if invoice.total %}
                        ${{ invoice.total }}
                    {% endif %}
                </td>
                <td>
                    {#{{ invoice.documents|length }}#}
                    {% if invoice.documents|length > 0 %}
                        <a  data-toggle="tooltip" title="Show the most recent PDF"
                            target="_blank"
                            href="{{ path('translationalresearch_invoice_download_recent', {'oid': invoice.oid }) }}"
                        >{{ invoice.documents|length }}</a>
                    {% endif %}
                </td>

                {#Actions#}
                <td class="rowlink-skip">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                            Action <span class="caret"></span>
                        </button>

                        <ul class="dropdown-menu dropdown-menu-right">

                            <li>
                                <a href="{{ path('translationalresearch_invoice_show', {'oid': invoice.oid }) }}">Show Invoice</a>
                            </li>

                            {% if invoice.latestVersion and is_granted('ROLE_TRANSRES_BILLING_ADMIN') %}
                                <li>
                                    <a href="{{ path('translationalresearch_invoice_edit', {'oid': invoice.oid }) }}">Edit Invoice</a>
                                </li>

                                {#<li>#}
                                    {#<a#}
                                        {#general-data-confirm="Are you sure you want to delete this invoice?"#}
                                        {#href="{{ path('translationalresearch_invoice_delete', {'id': invoice.id}) }}"#}
                                    {#>Delete</a>#}
                                {#</li>#}

                                {#<li>#}
                                    {#<a href="{{ path('translationalresearch_invoice_download', {'oid': invoice.oid }) }}"#}
                                    {#>PDF Invoice Preview</a>#}
                                {#</li>#}

                                {% if invoice.documents|length > 0 %}
                                    {% set generateLabel = "Regenerate Invoice PDF" %}
                                {% else %}
                                    {% set generateLabel = "Generate Invoice PDF" %}
                                {% endif %}
                                <li>
                                    <a
                                        general-data-confirm="Are you sure you want to {{ generateLabel|lower }} for this invoice {{ invoice.oid }}?"
                                        href="{{ path('translationalresearch_invoice_generate_pdf', {'oid': invoice.oid }) }}"
                                    >{{ generateLabel }}</a>
                                </li>

                                {% if invoice.documents|length > 0 %}
                                    <li>
                                        {#Send the Most Recent Invoice PDF by Email#}
                                        <a
                                            general-data-confirm="Are you sure you want to send the most recent invoice {{ invoice.oid }} pdf by email to PI?"
                                            href="{{ path('translationalresearch_invoice_send_pdf_email', {'oid': invoice.oid }) }}"
                                        >Send the Most Recent Invoice PDF by Email to PI</a>
                                    </li>
                                {% endif %}

                                <hr>
                                {#Add actions in the invoice list - "Change status to ..."#}
                                {% set statuses = transres_request_util.getInvoiceStatuses() %}
                                {% for status in statuses %}
                                    {% if status != invoice.status %}
                                        {% if status == "Paid Partially" %}
                                            {{ transresRequestMacros.unpaidModal(invoice) }}
                                            <a data-toggle="modal" data-target="#modal_update_invoice_{{ invoice.oid }}"
                                            >Change status to {{ status }}</a>
                                        {% else %}
                                            <li>
                                                <a
                                                    general-data-confirm="Are you sure you want to change the status of this invoice {{ invoice.oid }} to {{ status }}?"
                                                    href="{{ path('translationalresearch_invoice_change_status', {'oid':invoice.oid, 'status':status }) }}"
                                                >Change status to {{ status }}</a>
                                            </li>
                                        {% endif %}
                                        
                                    {% endif %}
                                {% endfor %}
                                <hr>

                            {% endif %}

                            {% if invoice.documents|length > 0 %}
                                <li>
                                    <a target="_blank"
                                       href="{{ path('translationalresearch_invoice_download_recent', {'oid': invoice.oid }) }}"
                                    >Show The Most Recent PDF Invoice</a>
                                </li>
                            {% endif %}

                            {#{% endif %}#}

                        </ul>
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% if transresRequest %}
        <br>
        <p>
            <a href="{{ path('translationalresearch_invoice_new', {'id': transresRequest.id}) }}">Create a new invoice</a>
        </p>
    {% endif %}
{% endblock %}


{% block additionaljs %}

<script type="text/javascript">

    $(document).ready(function() {

    });

    function transresUpdateInvoice(invoiceOid) {
        console.log("transresUpdateInvoice: invoiceOid="+invoiceOid);

//        $.ajax({
//            url: urlCommentSubmit,
//            type: 'POST',
//            data: {id: id, selectednote: selectednote, text: text},
//            timeout: _ajaxTimeout,
//            success: function (data) {
//                //console.log("OK submit a new comment");
//                comment_modal.modal('hide');
//                cleanModal();
//                if( _reload_page_after_modal == '1' ) {
//                    window.parent.location.reload();
//                }
//            },
//            error: function ( x, t, m ) {
//
//                if( t === "timeout" ) {
//                    getAjaxTimeoutMsg();
//                }
//
//                //console.log("Error submit a new comment");
//                var errormsg = '<div class="alert alert-danger">Error submitting a new comment</div>';
//                $('#modal_error_'+id).html(errormsg);
//                return false;
//                //comment_modal.modal('hide');
//            }
//        });
    }

</script>

{% endblock %}

