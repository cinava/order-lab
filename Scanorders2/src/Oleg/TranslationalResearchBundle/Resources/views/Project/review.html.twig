{% extends "OlegTranslationalResearchBundle::Default/base.html.twig" %}

{% import "OlegOrderformBundle::Default/formmacros.html.twig" as formmacros %}
{% import "OlegTranslationalResearchBundle::Default/transres.html.twig" as transres %}


{% block title %}
    {{ title }}
{% endblock %}


{% block content %}

    <input type="hidden" id="formcycle" value="{{ cycle }}" />
    <input type="hidden" id="projectid" value="{{ project.id }}" />

    <h4 class="text-info" align="center">
        {{ title }}
    </h4>
    <br>

    {% set sitename = translationalresearch_sitename %}


    {{ transres.getActionReviewCommentsSection(project,cycle,sitename,1) }}
    {#{% include 'FOSCommentBundle:Thread:async.html.twig' with {'id': "3-9-committee_review"} %}#}

    <p>
        <button type="button" class="btn btn-default btn-sm" onClick="collapseAll()" >Collapse All</button>
        <button type="button" class="btn btn-default btn-sm" onClick="extendAll()" >Expand All</button>
    </p>

    {#{{ form_start(form,{'attr': {'onsubmit':'transresUpdateIrbExpDate(this);'}}) }}#}
    {{ form_start(form) }}

    {#hidden field to be copied by JS#}
    {#{% if form.irbExpirationDate is defined %}#}
        {#{{ form_row(form.irbExpirationDate) }}#}
    {#{% endif %}#}

    {{ transres.getProjectShowPrototypeFormData(form,cycle,sitename) }}

    {{ transres.projectInfo(form,project,cycle) }}

    {{ transres.projectFormShow(form,project,cycle) }}

    {{ transres.projectRequesters(form,project,cycle) }}

    {{ transres.projectReviews(form,cycle,sitename,0) }}

    {{ form_end(form) }}

    {#{% set threadId = project.id %}#}
    {#{% include 'FOSCommentBundle:Thread:async.html.twig' with {'id': threadId} %}#}

    {#{% set callLogViewClass = "order-white-background" %}#}
    {#<div class="text-left {{ callLogViewClass }}">#}
        {#{{ user_formnode_utility.getFormNodeHolderShortInfoForView(project,project.messageCategory,false)|raw }}#}
    {#</div>#}

    {#{% include 'FOSCommentBundle:Thread:async.html.twig' with {'id': "3-9-committee_review"} %}#}
    {#{{ render(controller('OlegTranslationalResearchBundle:Project:threadComments', { 'id': "3-9-committee_review" })) }}#}

    <div>

        {#{% if is_granted('ROLE_TRANSRES_ADMIN') %}#}
            {#<br>#}
            {#<p>#}
                {#<a class="btn btn-warning" href="{{ path(translationalresearch_sitename~'_project_edit', { 'id': project.id }) }}">Edit project</a>#}
            {#</p>#}
        {#{% endif %}#}
        {#{{ transres.projectHeader(project) }}#}

        <br>
        <br>
        <p>
            <a href="{{ path(translationalresearch_sitename~'_project_index') }}">Back to the list</a>
        </p>

    </div>

{% endblock %}



{#{% block headeradditionaljs %}#}

    {#<script type="text/javascript">#}
        {#// thread id#}
        {#var fos_comment_thread_id = 'test';#}

        {#// api base url to use for initial requests#}
        {#var fos_comment_thread_api_base_url = '/sf2.1.2/web/app.php/api/threads';#}

        {#// Snippet for asynchronously loading the comments#}
        {#(function() {#}
            {#var fos_comment_script = document.createElement('script');#}
            {#fos_comment_script.async = true;#}
            {#fos_comment_script.src = '/sf2.1.2/web/js/35a8e64.js';#}
            {#fos_comment_script.type = 'text/javascript';#}

            {#(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(fos_comment_script);#}
        {#})();#}
    {#</script>#}

{#{% endblock %}#}

{% block additionaljs %}

<script type="text/javascript">

    $(document).ready(function() {

        //transres-review-submit
        $('.transres-review-submit').click(function(event) {
            //console.log("btn click:");
            //console.log($(this));
            event.stopPropagation();
            window.onbeforeunload = null;

            var reviewHolder = $(this).closest('.transres-review-holder');

            var comment = reviewHolder.find('.fos_comment_comment_new_form').find('textarea').val();
            console.log("comment="+comment);

            if( comment ) {
                reviewHolder.find('.fos_comment_comment_new_form').find('input[type="submit"]').click();
            }

            //get alert if the additional info button clicked and no comment is provided
//            if( $(this).hasClass('btn-warning') && !comment ) {
//                //event.stopPropagation();
//                alert('No comment is provided for requesting additional information');
//                return false;
//            }

            ////////// Update IRB Expiration Date by transres-irb_review //////////
            if( $(this).hasClass('transres-irb_review') ) {
                var irbExpDateEl = $('#transres_irbExpirationDate');
                if( irbExpDateEl && irbExpDateEl.length > 0 ) {
                    var irbExpDate = irbExpDateEl.val();
                    console.log("irbExpDate=" + irbExpDate);

                    var projectId = $("#projectid").val();

                    transresUpdateIrbExpDate(irbExpDate,projectId);
                    //return false;
                    //alert("Working on Update IRB expiration date by JS (Not implemented yet)");
                }
            }
            ////////// EOF Update IRB Expiration Date //////////

            console.log("done review");

            //return false;
        });

        function transresUpdateIrbExpDate(irbExpDate,projectId) {
            console.log("transresUpdateIrbExpDate: irbExpDate="+irbExpDate+"; projectId="+projectId);

            var url = Routing.generate('translationalresearch_update_irb_exp_date');
            //url = url + "/" + projectId + "/" + irbExpDate

            $.ajax({
                url: url,
                timeout: _ajaxTimeout,
                //type: "GET",
                type: "POST",
                data: {projectId: projectId, value: irbExpDate },
                //dataType: 'json',
                async: asyncflag
            }).success(function(response) {
                console.log(response);
            }).done(function() {
                //lbtn.stop();
            }).error(function(jqXHR, textStatus, errorThrown) {
                console.log('Error : ' + errorThrown);
            });

            return false;
        }

    });

</script>

{% endblock %}


{#{% block additionalcss %}#}
    {#{% stylesheets '@FOSCommentBundle/Resources/public/css/comments.css' %}#}
    {#<link rel="stylesheet" href="{{ asset_url }}" type="text/css" />#}
    {#{% endstylesheets %}#}
{#{% endblock %}#}


