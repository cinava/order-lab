packer {
  required_plugins {
    digitalocean = {
      version = ">= 1.0.4"
      source  = "github.com/digitalocean/digitalocean"
    }
  }
}

variable "ssh_name" {
  type    = string
  default = "root"
}

source "digitalocean" "autogenerated_1" {
  api_token    = "api_token_bash_value"
  image        = "almalinux-9-x64"
  region       = "nyc3"
  size         = "2gb"
  ssh_username = "${var.ssh_name}"
}

build {
  sources = ["source.digitalocean.autogenerated_1"]

  provisioner "shell" {
    environment_vars = ["bashdbuser=bash_dbuser", "bashdbpass=bash_dbpass"]
    script           = "alma9_install.sh"
  }

  provisioner "shell" {
    expect_disconnect = "true"
    inline            = ["echo @### Disable SELinux again ###", "sudo setenforce 0", "echo @### Reboot Server ###", "sudo shutdown -r now"]
  }

  provisioner "shell" {
    expect_disconnect = "true"
    inline            = ["echo @### Check SELinux status ###", "sestatus", "echo @### PostgreSQL Version after alma9_install ###", "psql --version"]
    pause_before      = "1m0s"
  }

  provisioner "shell" {
    inline = ["echo @### Copy parameters file [parameters_bash_file] to [/usr/local/bin/order-lab/orderflex/config/parameters_bash_file] ###"]
  }

  provisioner "file" {
    destination = "/usr/local/bin/order-lab/orderflex/config/parameters_bash_file"
    source      = "parameters_bash_file"
  }

  provisioner "shell" {
    inline = ["echo @### Create ssl folder /usr/local/bin/order-lab/ssl ###", "sudo mkdir /usr/local/bin/order-lab/ssl"]
  }

  provisioner "file" {
    destination = "/usr/local/bin/order-lab/ssl/apache2.crt"
    source      = "bash_sslcertificate"
  }

  provisioner "file" {
    destination = "/usr/local/bin/order-lab/ssl/apache2.key"
    source      = "bash_sslprivatekey"
  }

  provisioner "shell" {
    inline = ["echo @### PostgreSQL Version before final step ###", "psql --version"]
  }

  provisioner "shell" {
    inline = ["echo @### Composer and deploy using orderflex###", "cd /usr/local/bin/order-lab/orderflex", "composer self-update", "echo @### PostgreSQL Version after composer self-update ###", "psql --version", "echo @### Check SELinux status before composer ###", "sestatus", "echo @### Check OS Info before composer ###", "sudo hostnamectl", "composer install", "echo @### Check OS Info after composer ###", "sudo hostnamectl", "echo @### PostgreSQL Version after composer install ###", "psql --version", "echo @### Install yarn package.json ###", "sudo yarn install --frozen-lockfile", "echo @### Check OS Info after yarn ###", "sudo hostnamectl", "sudo chmod +x /usr/local/bin/order-lab/orderflex/deploy_prod.sh", "echo @### Check OS Info before deploy_prod.sh ###", "sudo hostnamectl", "bash /usr/local/bin/order-lab/orderflex/deploy_prod.sh -withdb", "sudo chown -R apache:apache /usr/local/bin/order-lab", "sudo chown -R apache:apache /usr/local/bin/order-lab/.git/", "echo @### PostgreSQL Version end of installation ###", "echo @### Check OS Info end of installation ###", "sudo hostnamectl", "psql --version"]
  }

}
