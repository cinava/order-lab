{

  "variables": {
        "ssh_name": "root"
  },	

  "builders": [{
    "type": "digitalocean",
    "api_token": "api_token_bash_value",
    "region": "nyc3",
    "size": "2gb",
    "image": "centos-7-x64",
    "ssh_username": "{{user `ssh_name`}}"  
  }],

  "provisioners": [
  
	{
        "type": "shell",
        "script": "centos_install.sh $bash_dbuser $bash_dbpass"
    },
	
	{
		"type": "file",
		"source": "parameters_bash_file",
		"destination": "/usr/local/bin/order-lab/Scanorders2/app/config/parameters_bash_file"         
	},
	
	{
        "type": "shell",
        "inline": [ 
           "echo @### Create ssl folder /usr/local/bin/order-lab/ssl ###",		
		   "sudo mkdir /usr/local/bin/order-lab/ssl"
         ]    
	},
	  
	  {
          "type": "file",
          "source": "bash_sslcertificate",
          "destination": "/usr/local/bin/order-lab/ssl/apache2.crt"         
       },
	   
	   {
          "type": "file",
          "source": "bash_sslprivatekey",
          "destination": "/usr/local/bin/order-lab/ssl/apache2.key"         
       },

	   {
		   "type": "shell",
           "inline": [ 
		   "echo @### Enable ssl ###",		   
		   "cp /usr/local/bin/order-lab/packer/default-ssl.conf /etc/apache2/sites-available/",
           "sudo a2enmod ssl",          
		   "sudo a2enmod headers",	
           "sudo a2ensite default-ssl",
		   "sudo systemctl restart apache2"		   
         ]    
      },
	  
	  {
        "type": "shell",
        "inline": [ 
		   "echo @### Composer and deploy ###",
           "cd /usr/local/bin/order-lab/Scanorders2",		  
		   "composer self-update",
           "php -dmemory_limit=-1 /usr/local/bin/composer install",
		   "git pull",
           "git rev-parse HEAD",		   
	       "sudo chmod +x /usr/local/bin/order-lab/Scanorders2/deploy_prod.sh",
	       "bash /usr/local/bin/order-lab/Scanorders2/deploy_prod.sh",
	       "sudo chown -R www-data:www-data /usr/local/bin/order-lab",		           
           "sudo chown -R www-data:www-data /usr/local/bin/order-lab/.git/"			   
         ]    
      } 
      
   ]

}
